<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Guidance System v2.1 — Review Playground</title>
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --surface2: #1c2333; --border: #30363d;
    --text: #e6edf3; --dim: #8b949e; --accent: #58a6ff; --green: #3fb950;
    --orange: #d29922; --red: #f85149; --purple: #bc8cff; --cyan: #39d2c0; --pink: #f778ba;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'SF Mono','Cascadia Code','Fira Code',monospace; font-size:13px; display:flex; height:100vh; overflow:hidden; }

  /* ── Sidebar ── */
  .sidebar { width:260px; min-width:260px; background:var(--surface); border-right:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; }
  .sidebar-header { padding:16px; border-bottom:1px solid var(--border); }
  .sidebar-header h1 { font-size:15px; color:var(--accent); margin-bottom:4px; }
  .sidebar-header .sub { font-size:10px; color:var(--dim); }
  .progress-bar { height:4px; background:var(--border); border-radius:2px; margin-top:10px; overflow:hidden; }
  .progress-fill { height:100%; background:var(--green); transition:width 0.3s; border-radius:2px; }
  .progress-text { font-size:10px; color:var(--dim); margin-top:4px; }

  .nav { flex:1; overflow-y:auto; padding:8px; }
  .nav-item { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:6px; cursor:pointer; font-size:11px; color:var(--dim); transition:all 0.15s; margin-bottom:2px; }
  .nav-item:hover { background:rgba(255,255,255,0.04); color:var(--text); }
  .nav-item.active { background:rgba(88,166,255,0.1); color:var(--accent); }
  .nav-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; border:1.5px solid var(--border); }
  .nav-dot.approved { background:var(--green); border-color:var(--green); }
  .nav-dot.rejected { background:var(--red); border-color:var(--red); }
  .nav-dot.commented { background:var(--orange); border-color:var(--orange); }
  .nav-label { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .nav-section { font-size:9px; color:var(--dim); padding:12px 10px 4px; text-transform:uppercase; letter-spacing:1px; }

  .sidebar-footer { padding:12px; border-top:1px solid var(--border); display:flex; gap:8px; }
  .sidebar-footer button { flex:1; padding:8px; border:1px solid var(--border); border-radius:6px; background:var(--surface2); color:var(--text); font-family:inherit; font-size:11px; cursor:pointer; transition:all 0.15s; }
  .sidebar-footer button:hover { border-color:var(--accent); color:var(--accent); }
  .sidebar-footer button.export { background:rgba(88,166,255,0.1); border-color:var(--accent); color:var(--accent); }

  /* ── Main ── */
  .main { flex:1; overflow-y:auto; scroll-behavior:smooth; }
  .main-inner { max-width:960px; margin:0 auto; padding:24px 32px 80px; }

  /* ── Section ── */
  .section { margin-bottom:32px; border:1px solid var(--border); border-radius:10px; background:var(--surface); overflow:hidden; }
  .section.approved { border-color:rgba(63,185,80,0.3); }
  .section.rejected { border-color:rgba(248,81,73,0.3); }
  .section.commented { border-color:rgba(210,153,34,0.3); }

  .section-head { display:flex; align-items:center; padding:16px 20px; cursor:pointer; user-select:none; gap:12px; }
  .section-head:hover { background:rgba(255,255,255,0.02); }
  .section-chevron { color:var(--dim); font-size:12px; transition:transform 0.2s; flex-shrink:0; }
  .section.open .section-chevron { transform:rotate(90deg); }
  .section-tag { font-size:9px; padding:2px 8px; border-radius:4px; font-weight:600; letter-spacing:0.5px; flex-shrink:0; }
  .section-title { flex:1; font-size:14px; font-weight:600; }
  .section-status { font-size:10px; padding:3px 10px; border-radius:10px; }
  .section-status.pending { color:var(--dim); background:rgba(139,148,158,0.1); }
  .section-status.approved { color:var(--green); background:rgba(63,185,80,0.1); }
  .section-status.rejected { color:var(--red); background:rgba(248,81,73,0.1); }
  .section-status.commented { color:var(--orange); background:rgba(210,153,34,0.1); }

  .section-body { display:none; padding:0 20px 20px; }
  .section.open .section-body { display:block; }

  .section-content { line-height:1.7; color:var(--text); font-size:12px; }
  .section-content h3 { color:var(--accent); font-size:13px; margin:16px 0 8px; }
  .section-content h4 { color:var(--orange); font-size:12px; margin:12px 0 6px; }
  .section-content p { margin:6px 0; }
  .section-content code { background:rgba(88,166,255,0.12); color:var(--accent); padding:1px 5px; border-radius:3px; font-size:11px; }
  .section-content .dim { color:var(--dim); }
  .section-content ul { padding-left:20px; margin:6px 0; }
  .section-content li { margin:3px 0; }

  /* ── Tables in content ── */
  .section-content table { width:100%; border-collapse:collapse; font-size:11px; margin:10px 0; }
  .section-content th { text-align:left; padding:8px 10px; border-bottom:2px solid var(--accent); color:var(--accent); font-weight:600; }
  .section-content td { padding:6px 10px; border-bottom:1px solid var(--border); }
  .section-content tr:hover td { background:rgba(88,166,255,0.03); }

  /* ── Diagram boxes ── */
  .diagram { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0; }
  .dbox { flex:1; min-width:200px; background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:8px; padding:12px; }
  .dbox-label { font-size:10px; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; }
  .dbox-label.green { color:var(--green); } .dbox-label.orange { color:var(--orange); }
  .dbox-label.purple { color:var(--purple); } .dbox-label.cyan { color:var(--cyan); }
  .dbox-label.pink { color:var(--pink); } .dbox-label.accent { color:var(--accent); }

  .arrow-d { text-align:center; color:var(--dim); font-size:18px; padding:4px 0; }

  /* ── Flow steps ── */
  .flow-steps { counter-reset:step; margin:12px 0; }
  .flow-step { display:flex; gap:12px; padding:8px 0; border-bottom:1px solid rgba(48,54,61,0.5); }
  .flow-step:last-child { border-bottom:none; }
  .step-num { counter-increment:step; width:24px; height:24px; border-radius:50%; background:rgba(88,166,255,0.15); color:var(--accent); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; flex-shrink:0; }
  .step-num::before { content:counter(step); }
  .step-content { flex:1; }

  /* ── ID visual ── */
  .id-vis { display:flex; gap:0; align-items:flex-start; flex-wrap:wrap; margin:12px 0; }
  .id-seg { text-align:center; }
  .id-seg .v { padding:6px 8px; font-size:12px; font-weight:600; border:1px solid var(--border); background:var(--surface2); }
  .id-seg .l { font-size:9px; color:var(--dim); margin-top:4px; max-width:110px; line-height:1.3; }
  .id-sep { font-size:16px; color:var(--dim); padding-top:6px; }

  /* ── Cypher block ── */
  .cypher { background:#0d1117; border:1px solid var(--border); border-radius:6px; padding:12px; margin:8px 0; font-size:11px; line-height:1.6; overflow-x:auto; white-space:pre; color:var(--cyan); }

  /* ── Review controls ── */
  .review { margin-top:16px; padding-top:16px; border-top:1px solid var(--border); }
  .review-actions { display:flex; gap:8px; margin-bottom:10px; }
  .review-btn { padding:7px 16px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); color:var(--dim); font-family:inherit; font-size:11px; cursor:pointer; transition:all 0.15s; }
  .review-btn:hover { color:var(--text); }
  .review-btn.approve { border-color:var(--green); color:var(--green); }
  .review-btn.approve.active { background:rgba(63,185,80,0.15); }
  .review-btn.reject { border-color:var(--red); color:var(--red); }
  .review-btn.reject.active { background:rgba(248,81,73,0.15); }
  .review-comment { width:100%; background:var(--bg); border:1px solid var(--border); border-radius:6px; padding:10px; color:var(--text); font-family:inherit; font-size:12px; resize:vertical; min-height:60px; margin-top:8px; display:none; }
  .review-comment:focus { border-color:var(--accent); outline:none; }
  .review-comment.show { display:block; }
  .review-btn.comment { border-color:var(--orange); color:var(--orange); }
  .review-btn.comment.active { background:rgba(210,153,34,0.15); }

  /* ── Tag chips ── */
  .tag { display:inline-block; padding:2px 8px; border-radius:4px; font-size:10px; font-weight:600; }
  .tag-yes { background:rgba(63,185,80,0.15); color:var(--green); }
  .tag-no { background:rgba(248,81,73,0.15); color:var(--red); }
  .tag-ref { background:rgba(188,140,255,0.15); color:var(--purple); }
  .tag-new { background:rgba(88,166,255,0.15); color:var(--accent); }
  .tag-reuse { background:rgba(57,210,192,0.15); color:var(--cyan); }

  /* ── Export modal ── */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:100; align-items:center; justify-content:center; }
  .modal-overlay.show { display:flex; }
  .modal { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:24px; max-width:700px; width:90%; max-height:80vh; overflow-y:auto; }
  .modal h2 { color:var(--accent); font-size:16px; margin-bottom:12px; }
  .modal pre { background:var(--bg); border:1px solid var(--border); border-radius:6px; padding:16px; font-size:11px; line-height:1.6; white-space:pre-wrap; max-height:50vh; overflow-y:auto; }
  .modal-actions { display:flex; gap:8px; margin-top:16px; justify-content:flex-end; }
  .modal-actions button { padding:8px 20px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-family:inherit; font-size:12px; cursor:pointer; }
  .modal-actions button.primary { background:rgba(88,166,255,0.15); border-color:var(--accent); color:var(--accent); }

  /* ── Graph SVG ── */
  .graph-svg { width:100%; height:auto; margin:12px 0; }

  /* ── Responsive ── */
  @media (max-width:800px) {
    .sidebar { width:52px; min-width:52px; }
    .sidebar-header h1, .sidebar-header .sub, .progress-text, .nav-label, .nav-section, .sidebar-footer button span { display:none; }
    .nav-item { justify-content:center; padding:10px; }
    .sidebar-footer button { padding:8px 4px; font-size:10px; }
  }
</style>
</head>
<body>

<!-- ═══════════ SIDEBAR ═══════════ -->
<div class="sidebar">
  <div class="sidebar-header">
    <h1>Guidance v2.1</h1>
    <div class="sub">Review Playground</div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-text" id="progressText">0 / 14 reviewed</div>
  </div>
  <div class="nav" id="nav"></div>
  <div class="sidebar-footer">
    <button onclick="resetAll()"><span>Reset</span>&#x21bb;</button>
    <button class="export" onclick="showExport()"><span>Export</span>&#x2197;</button>
  </div>
</div>

<!-- ═══════════ MAIN ═══════════ -->
<div class="main" id="main">
<div class="main-inner" id="sections"></div>
</div>

<!-- ═══════════ EXPORT MODAL ═══════════ -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2>Review Summary</h2>
    <pre id="exportContent"></pre>
    <div class="modal-actions">
      <button onclick="copyExport()">Copy to Clipboard</button>
      <button class="primary" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<script>
// ════════════════════════════════════════════
// DATA: All 14 sections from the spec
// ════════════════════════════════════════════
const sections = [
{
  id: "schema",
  num: "§1",
  title: "Graph Schema",
  color: "#bc8cff",
  content: `
<h3>Architecture Overview</h3>
<p><strong>2 new node types</strong>: <code>Guidance</code> (generic metric tag) + <code>GuidanceUpdate</code> (per-mention data point)<br>
<strong>5 reused nodes</strong>: <code>Context</code>, <code>Period</code>, <code>Company</code>, <code>Concept</code>, <code>Member</code></p>

<svg class="graph-svg" viewBox="0 0 920 580" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="aG" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#8b949e"/></marker>
    <marker id="aD" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#58a6ff"/></marker>
  </defs>
  <pattern id="gr" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M40 0L0 0 0 40" fill="none" stroke="#1a2030" stroke-width=".5"/></pattern>
  <rect width="920" height="580" fill="url(#gr)"/>

  <line x1="360" y1="230" x2="360" y2="110" stroke="#8b949e" stroke-width="2" marker-end="url(#aG)"/>
  <text x="375" y="174" fill="#3fb950" font-size="11" font-family="monospace">UPDATES</text>

  <line x1="460" y1="270" x2="600" y2="270" stroke="#8b949e" stroke-width="2" marker-end="url(#aG)"/>
  <text x="490" y="262" fill="#3fb950" font-size="11" font-family="monospace">IN_CONTEXT</text>

  <line x1="260" y1="290" x2="130" y2="380" stroke="#8b949e" stroke-width="2" marker-end="url(#aG)"/>
  <text x="148" y="332" fill="#3fb950" font-size="11" font-family="monospace">FROM_SOURCE</text>

  <line x1="700" y1="310" x2="700" y2="410" stroke="#8b949e" stroke-width="2" marker-end="url(#aG)"/>
  <text x="715" y="365" fill="#3fb950" font-size="11" font-family="monospace">FOR_COMPANY</text>

  <line x1="760" y1="260" x2="840" y2="175" stroke="#8b949e" stroke-width="2" marker-end="url(#aG)"/>
  <text x="790" y="208" fill="#3fb950" font-size="11" font-family="monospace">HAS_PERIOD</text>

  <line x1="440" y1="70" x2="600" y2="70" stroke="#58a6ff" stroke-width="2" stroke-dasharray="6,4" marker-end="url(#aD)"/>
  <text x="455" y="58" fill="#58a6ff" font-size="11" font-family="monospace">MAPS_TO_CONCEPT</text>

  <line x1="400" y1="310" x2="550" y2="450" stroke="#58a6ff" stroke-width="2" stroke-dasharray="6,4" marker-end="url(#aD)"/>
  <text x="430" y="390" fill="#58a6ff" font-size="11" font-family="monospace">MAPS_TO_MEMBER</text>

  <rect x="260" y="42" width="200" height="56" rx="10" fill="#1a1a2e" stroke="#bc8cff" stroke-width="2"/>
  <text x="310" y="66" fill="#bc8cff" font-size="14" font-weight="bold" font-family="monospace">Guidance</text>
  <text x="280" y="86" fill="#8b949e" font-size="10" font-family="monospace">id | label | aliases</text>

  <rect x="260" y="230" width="200" height="76" rx="10" fill="#1a1a2e" stroke="#3fb950" stroke-width="2"/>
  <text x="280" y="254" fill="#3fb950" font-size="14" font-weight="bold" font-family="monospace">GuidanceUpdate</text>
  <text x="280" y="274" fill="#8b949e" font-size="10" font-family="monospace">id | evhash16 | 19 fields</text>
  <text x="280" y="294" fill="#8b949e" font-size="10" font-family="monospace">low|mid|high|unit|basis ...</text>

  <rect x="600" y="240" width="180" height="56" rx="10" fill="#1a1a2e" stroke="#39d2c0" stroke-width="2"/>
  <text x="650" y="264" fill="#39d2c0" font-size="14" font-weight="bold" font-family="monospace">Context</text>
  <text x="618" y="284" fill="#8b949e" font-size="10" font-family="monospace">u_id | cik | period_u_id</text>

  <rect x="810" y="136" width="100" height="50" rx="10" fill="#1a1a2e" stroke="#39d2c0" stroke-width="2"/>
  <text x="834" y="158" fill="#39d2c0" font-size="14" font-weight="bold" font-family="monospace">Period</text>
  <text x="822" y="176" fill="#8b949e" font-size="10" font-family="monospace">start | end</text>

  <rect x="630" y="420" width="140" height="50" rx="10" fill="#1a1a2e" stroke="#d29922" stroke-width="2"/>
  <text x="660" y="444" fill="#d29922" font-size="14" font-weight="bold" font-family="monospace">Company</text>
  <text x="650" y="462" fill="#8b949e" font-size="10" font-family="monospace">ticker | cik</text>

  <rect x="600" y="42" width="160" height="56" rx="10" fill="#1a1a2e" stroke="#58a6ff" stroke-width="2" stroke-dasharray="6,4"/>
  <text x="635" y="66" fill="#58a6ff" font-size="14" font-weight="bold" font-family="monospace">Concept</text>
  <text x="618" y="86" fill="#8b949e" font-size="10" font-family="monospace">qname | label (XBRL)</text>

  <rect x="510" y="440" width="110" height="46" rx="10" fill="#1a1a2e" stroke="#58a6ff" stroke-width="2" stroke-dasharray="6,4"/>
  <text x="530" y="464" fill="#58a6ff" font-size="14" font-weight="bold" font-family="monospace">Member</text>

  <rect x="30" y="370" width="170" height="40" rx="8" fill="#1a1a2e" stroke="#d29922" stroke-width="1.5"/>
  <text x="50" y="394" fill="#d29922" font-size="12" font-family="monospace">Report (8-K/10-Q/K)</text>
  <rect x="30" y="420" width="170" height="36" rx="8" fill="#1a1a2e" stroke="#d29922" stroke-width="1.5"/>
  <text x="70" y="442" fill="#d29922" font-size="12" font-family="monospace">Transcript</text>
  <rect x="30" y="466" width="170" height="36" rx="8" fill="#1a1a2e" stroke="#d29922" stroke-width="1.5"/>
  <text x="90" y="488" fill="#d29922" font-size="12" font-family="monospace">News</text>
  <line x1="130" y1="420" x2="260" y2="300" stroke="#8b949e" stroke-width="1" stroke-dasharray="4,3"/>
  <line x1="130" y1="466" x2="260" y2="305" stroke="#8b949e" stroke-width="1" stroke-dasharray="4,3"/>

  <rect x="20" y="520" width="880" height="44" rx="8" fill="#161b22" stroke="#30363d"/>
  <line x1="50" y1="542" x2="90" y2="542" stroke="#8b949e" stroke-width="2"/>
  <text x="95" y="546" fill="#8b949e" font-size="10" font-family="monospace">Always</text>
  <line x1="200" y1="542" x2="240" y2="542" stroke="#58a6ff" stroke-width="2" stroke-dasharray="6,4"/>
  <text x="245" y="546" fill="#8b949e" font-size="10" font-family="monospace">Optional (confidence-gated)</text>
  <rect x="450" y="534" width="14" height="14" rx="3" fill="#1a1a2e" stroke="#3fb950" stroke-width="1.5"/>
  <text x="470" y="546" fill="#8b949e" font-size="10" font-family="monospace">New</text>
  <rect x="530" y="534" width="14" height="14" rx="3" fill="#1a1a2e" stroke="#d29922" stroke-width="1.5"/>
  <text x="550" y="546" fill="#8b949e" font-size="10" font-family="monospace">Reused</text>
  <rect x="630" y="534" width="14" height="14" rx="3" fill="#1a1a2e" stroke="#58a6ff" stroke-width="1.5" stroke-dasharray="4,3"/>
  <text x="650" y="546" fill="#8b949e" font-size="10" font-family="monospace">XBRL (optional link target)</text>
</svg>

<h3>Required Constraints</h3>
<div class="cypher">CREATE CONSTRAINT guidance_id_unique IF NOT EXISTS
FOR (g:Guidance) REQUIRE g.id IS UNIQUE;

CREATE CONSTRAINT guidance_update_id_unique IF NOT EXISTS
FOR (gu:GuidanceUpdate) REQUIRE gu.id IS UNIQUE;

CREATE CONSTRAINT context_uid_unique IF NOT EXISTS
FOR (ctx:Context) REQUIRE ctx.u_id IS UNIQUE;

CREATE CONSTRAINT period_uid_unique IF NOT EXISTS
FOR (p:Period) REQUIRE p.u_id IS UNIQUE;</div>
`
},
{
  id: "fields",
  num: "§2",
  title: "Extraction Fields (19 props)",
  color: "#3fb950",
  content: `
<h3>GuidanceUpdate Properties</h3>
<table>
<tr><th>#</th><th>Field</th><th>Type</th><th>Constraint / Enum</th><th>Example</th></tr>
<tr><td>1</td><td><code>given_date</code></td><td>String</td><td>ISO date</td><td>2025-01-30</td></tr>
<tr><td>2</td><td><code>period_type</code></td><td>String</td><td><code>quarter|annual|half|long-range|other</code></td><td>quarter</td></tr>
<tr><td>3</td><td><code>fiscal_year</code></td><td>Integer</td><td></td><td>2025</td></tr>
<tr><td>4</td><td><code>fiscal_quarter</code></td><td>Int/null</td><td>1-4; null for annual</td><td>2</td></tr>
<tr><td>5</td><td><code>segment</code></td><td>String</td><td>Default "Total"</td><td>Services</td></tr>
<tr><td>6</td><td><code>low</code></td><td>Float/null</td><td></td><td>94.0</td></tr>
<tr><td>7</td><td><code>mid</code></td><td>Float/null</td><td>Computed if low+high given</td><td>95.5</td></tr>
<tr><td>8</td><td><code>high</code></td><td>Float/null</td><td></td><td>97.0</td></tr>
<tr><td>9</td><td><code>unit</code></td><td>String</td><td><code>usd|m_usd|percent|percent_yoy|x|count|unknown</code></td><td>m_usd</td></tr>
<tr><td>10</td><td><code>basis_norm</code></td><td>String</td><td><code>gaap|non_gaap|constant_currency|unknown</code></td><td>non_gaap</td></tr>
<tr><td>11</td><td><code>basis_raw</code></td><td>String/null</td><td>Verbatim from source</td><td>non-GAAP</td></tr>
<tr><td>12</td><td><code>derivation</code></td><td>String</td><td><code>explicit|calculated|point|implied|floor|ceiling|comparative</code></td><td>explicit</td></tr>
<tr><td>13</td><td><code>qualitative</code></td><td>String/null</td><td>Non-numeric text</td><td>low to mid single digits</td></tr>
<tr><td>14</td><td><code>quote</code></td><td>String</td><td>Max 500 chars</td><td>We expect revenue between...</td></tr>
<tr><td>15</td><td><code>section</code></td><td>String</td><td>Location within source</td><td>CFO Prepared Remarks</td></tr>
<tr><td>16</td><td><code>source_key</code></td><td>String</td><td>Sub-document key</td><td>EX-99.1</td></tr>
<tr><td>17</td><td><code>conditions</code></td><td>String/null</td><td>Conditional assumptions</td><td>assumes no rate hikes</td></tr>
<tr><td>18</td><td><code>source_type</code></td><td>String</td><td><code>8k|transcript|news|10q|10k</code></td><td>transcript</td></tr>
<tr><td>19</td><td><code>created</code></td><td>String</td><td>ISO timestamp</td><td>2026-02-18T14:30:00Z</td></tr>
</table>

<h3>Key Rules</h3>
<ul>
<li><strong>Basis rule</strong>: <code>basis_norm</code> assigned only when qualifier is explicit in the same metric quote span. Otherwise <code>unknown</code>.</li>
<li><strong>Mapping</strong>: <code>adjusted</code> → <code>non_gaap</code>; <code>as reported</code> → <code>gaap</code></li>
<li><strong>No citation = no node</strong>: Every GuidanceUpdate must have <code>quote</code>, <code>FROM_SOURCE</code>, and <code>given_date</code></li>
<li><strong>LLM + validator contract</strong>: LLM proposes; deterministic validator enforces canonicalization + confidence gates</li>
</ul>
`
},
{
  id: "ids",
  num: "§2A",
  title: "Deterministic IDs & Idempotency",
  color: "#f778ba",
  content: `
<h3>Universal Rule</h3>
<p>No UUIDs, no sequences. Writes use <code>MERGE</code> on <code>id</code>. Same input = same ID = idempotent no-op.</p>

<h3>GuidanceUpdate ID (7 components)</h3>
<div class="id-vis">
  <div class="id-seg"><div class="v" style="color:var(--dim);border-radius:6px 0 0 6px">gu</div><div class="l">prefix</div></div>
  <div class="id-sep">:</div>
  <div class="id-seg"><div class="v" style="color:var(--orange)">0000320193-25-000008</div><div class="l">source_id</div></div>
  <div class="id-sep">:</div>
  <div class="id-seg"><div class="v" style="color:var(--green)">revenue</div><div class="l">label_slug</div></div>
  <div class="id-sep">:</div>
  <div class="id-seg"><div class="v" style="color:var(--accent)">duration_2025-01-01_2025-03-31</div><div class="l">period_u_id</div></div>
  <div class="id-sep">:</div>
  <div class="id-seg"><div class="v" style="color:var(--purple)">non_gaap</div><div class="l">basis_norm</div></div>
  <div class="id-sep">:</div>
  <div class="id-seg"><div class="v" style="color:var(--cyan)">total</div><div class="l">segment_slug</div></div>
  <div class="id-sep">:</div>
  <div class="id-seg"><div class="v" style="color:var(--pink);border-radius:0 6px 6px 0">a3f8b21c9e4d7012</div><div class="l">evhash16</div></div>
</div>

<h3>evhash16 (Evidence Hash)</h3>
<div class="cypher">sha256("{low}|{mid}|{high}|{unit}|{qualitative}|{conditions}")[:16]

Canonicalization:
  - Aggregate currency → m_usd ($1.13B → 1130|...|m_usd)
  - Per-share (EPS/DPS) → usd
  - Percentage → percent or percent_yoy
  - Text: lowercase + trimmed + whitespace-collapsed
  - Nulls → "."</div>

<h3>Guidance ID (simpler)</h3>
<div class="id-vis">
  <div class="id-seg"><div class="v" style="color:var(--dim);border-radius:6px 0 0 6px">guidance</div><div class="l">prefix</div></div>
  <div class="id-sep">:</div>
  <div class="id-seg"><div class="v" style="color:var(--green);border-radius:0 6px 6px 0">revenue</div><div class="l">slug(label) — shared across all companies</div></div>
</div>

<h3>Canonicalization Rules</h3>
<ul>
<li><code>source_id</code>: trim whitespace; replace <code>:</code> with <code>_</code> for delimiter safety</li>
<li><code>label_slug</code>: <code>label.lower().replace(" ", "_")</code></li>
<li><code>segment_slug</code>: <code>segment.lower().replace(" ", "_")</code> (default <code>total</code>)</li>
<li><code>basis_norm</code>: enum as-is</li>
<li><code>period_u_id</code>: from resolved Context (<code>duration_*</code>, <code>other_medium_term</code>, <code>undefined</code>)</li>
</ul>

<h3>Expected Behavior</h3>
<ul>
<li>Same source + same slot + same values → same <code>id</code> (idempotent)</li>
<li>Same source + same metric but different period/basis/segment → different <code>id</code></li>
<li>Same source + same slot but changed values → different <code>id</code> (new node via evhash16)</li>
</ul>
`
},
{
  id: "sources",
  num: "§3",
  title: "Source Processing & Routing",
  color: "#d29922",
  content: `
<h3>Source Richness & Extraction Rules</h3>
<table>
<tr><th>Source</th><th>Rich</th><th>Extract?</th><th>Scan Scope</th><th>given_date</th><th>source_key</th><th>Exclude</th></tr>
<tr><td><strong>Transcript</strong></td><td>Highest</td><td><span class="tag tag-yes">YES</span></td><td>Full: CFO, CEO, Q&A</td><td><code>conference_datetime</code></td><td><code>full</code></td><td>—</td></tr>
<tr><td><strong>8-K EX-99.1</strong></td><td>High</td><td><span class="tag tag-yes">YES</span></td><td>Outlook → tables → footnotes</td><td><code>r.created</code></td><td><code>EX-99.1</code></td><td>Actuals, safe harbor</td></tr>
<tr><td><strong>News</strong></td><td>Medium</td><td><span class="tag tag-yes">YES</span></td><td>Title + body (post filter)</td><td><code>n.created</code></td><td><code>title</code></td><td>Analyst ests ("Est $X")</td></tr>
<tr><td><strong>10-Q / 10-K</strong></td><td>Low</td><td><span class="tag tag-yes">YES</span></td><td>MD&A only</td><td><code>r.created</code></td><td><code>MD&A</code></td><td>Boilerplate</td></tr>
<tr><td>XBRL</td><td>None</td><td><span class="tag tag-no">NO</span></td><td>—</td><td>—</td><td>—</td><td>Actuals only</td></tr>
<tr><td>Alpha Vantage</td><td>Ref</td><td><span class="tag tag-ref">REF</span></td><td>—</td><td>—</td><td>—</td><td>Consensus only</td></tr>
</table>

<h3>News Channel Filter (Pre-LLM)</h3>
<table>
<tr><th>Channel</th><th>Priority</th><th>Count</th></tr>
<tr><td>Guidance</td><td><span class="tag tag-yes">PRIMARY</span></td><td>21,085</td></tr>
<tr><td>Earnings</td><td><span class="tag tag-yes">PRIMARY</span></td><td>49,344</td></tr>
<tr><td>Earnings Beats</td><td><span class="tag tag-ref">SECONDARY</span></td><td>5,784</td></tr>
<tr><td>Earnings Misses</td><td><span class="tag tag-ref">SECONDARY</span></td><td>2,679</td></tr>
<tr><td>Previews</td><td><span class="tag tag-ref">SECONDARY</span></td><td>587</td></tr>
<tr><td>Management</td><td><span class="tag tag-ref">SECONDARY</span></td><td>4,409</td></tr>
</table>

<h3>Forward Guidance Recall Pass (All Assets)</h3>
<div class="flow-steps">
<div class="flow-step"><div class="step-num"></div><div class="step-content">Build searchable text from scoped region only (EX-99.1, MD&A, transcript full, or filtered news)</div></div>
<div class="flow-step"><div class="step-num"></div><div class="step-content">Find forward-guidance candidate windows with keyword hits (<code>expects</code>, <code>guidance</code>, <code>outlook</code>, <code>forecast</code>, <code>target</code>, <code>range</code>, <code>raise</code>, <code>lower</code>, <code>maintain</code>, <code>reaffirm</code>)</div></div>
<div class="flow-step"><div class="step-num"></div><div class="step-content">Keep windows only if at least one metric/period/value signal is present nearby</div></div>
<div class="flow-step"><div class="step-num"></div><div class="step-content">Send candidate windows to LLM extractor</div></div>
<div class="flow-step"><div class="step-num"></div><div class="step-content">If zero candidates for high-priority sources (transcript, 8-K with EX-99.1), run one fallback full-scope pass</div></div>
</div>

<h3>News Reaffirm Guardrail</h3>
<ul>
<li>If news contains reaffirmation verbs (<code>reaffirm</code>, <code>maintain</code>, <code>keep</code>, <code>unchanged</code>), annotate in <code>conditions</code></li>
<li>Extract exact values stated; do NOT rewrite to prior guidance</li>
<li>Deterministic IDs preserve both history and source-level differences</li>
</ul>
`
},
{
  id: "metrics",
  num: "§4",
  title: "Metric Normalization (12 Canonical)",
  color: "#58a6ff",
  content: `
<h3>Standard Labels → Variant Mapping</h3>
<table>
<tr><th>Standard Label</th><th>Variants (source text)</th></tr>
<tr><td><code>Revenue</code></td><td>revenue, sales, net revenue, total revenue, net sales</td></tr>
<tr><td><code>EPS</code></td><td>EPS, earnings per share, diluted EPS</td></tr>
<tr><td><code>Gross Margin</code></td><td>gross margin, GM, gross profit margin</td></tr>
<tr><td><code>Operating Margin</code></td><td>operating margin, op margin</td></tr>
<tr><td><code>Operating Income</code></td><td>operating income, income from operations</td></tr>
<tr><td><code>Net Income</code></td><td>net income, net earnings, bottom line</td></tr>
<tr><td><code>OpEx</code></td><td>operating expenses, SG&A, R&D + SG&A</td></tr>
<tr><td><code>Tax Rate</code></td><td>effective tax rate, tax rate, provision for income taxes</td></tr>
<tr><td><code>CapEx</code></td><td>capital expenditures, capex, capital spending</td></tr>
<tr><td><code>FCF</code></td><td>free cash flow, operating cash flow minus capex</td></tr>
<tr><td><code>OINE</code></td><td>other income and expense, other income/expense net</td></tr>
<tr><td><code>D&A</code></td><td>depreciation and amortization, D&A, depreciation</td></tr>
</table>

<h3>Rules</h3>
<ul>
<li>This is a <strong>starting set, not exhaustive</strong>. LLM creates new Guidance nodes for company-specific metrics (e.g., "Services Revenue" for AAPL)</li>
<li>Aliases stored on Guidance node in <code>aliases[]</code></li>
<li><code>Guidance.id = guidance:{slug(label)}</code> so <code>guidance:revenue</code> is shared across all companies</li>
</ul>
`
},
{
  id: "derivation",
  num: "§5",
  title: "Derivation Rules (7 Types)",
  color: "#f778ba",
  content: `
<table>
<tr><th>Derivation</th><th>When</th><th>low/mid/high</th><th>Example</th></tr>
<tr><td><code>explicit</code></td><td>Company states all values</td><td>All from source</td><td>"revenue of $94-97B"</td></tr>
<tr><td><code>calculated</code></td><td>Agent computed mid</td><td>low+high from source</td><td>mid = (94+97)/2</td></tr>
<tr><td><code>point</code></td><td>Single value given</td><td>low=mid=high</td><td>"CapEx of ~$2B"</td></tr>
<tr><td><code>implied</code></td><td>Qualitative only</td><td>all null</td><td>"low single digits"</td></tr>
<tr><td><code>floor</code></td><td>Lower bound only</td><td>low set, mid/high null</td><td>"at least $150M"</td></tr>
<tr><td><code>ceiling</code></td><td>Upper bound only</td><td>high set, low/mid null</td><td>"up to $500M"</td></tr>
<tr><td><code>comparative</code></td><td>Relative phrasing</td><td>all null</td><td>"roughly in line with Q2"</td></tr>
</table>

<h3>Encoding Rules</h3>
<ul>
<li><code>floor</code>/<code>ceiling</code> do NOT force fabricated midpoints</li>
<li><code>comparative</code> keeps numeric fields null; anchor meaning stays in <code>qualitative</code>/<code>conditions</code> and <code>quote</code></li>
<li>Qualitative needs quantitative anchor ("low single digits" ✓, "significant" ✗)</li>
</ul>
`
},
{
  id: "context",
  num: "§6",
  title: "Context Resolution (Algorithm)",
  color: "#39d2c0",
  content: `
<h3>Goal</h3>
<p>Every GuidanceUpdate links to a <code>Context</code> node via <code>IN_CONTEXT</code>. Context provides company + period scoping, structurally identical to XBRL Contexts so future ingestion can reuse them.</p>

<h3>Context Properties</h3>
<table>
<tr><th>Property</th><th>Type</th><th>Example</th></tr>
<tr><td><code>id</code></td><td>String</td><td>guidance_320193_duration_2025-09-28_2025-12-27</td></tr>
<tr><td><code>u_id</code></td><td>String</td><td>= id (XBRL-compatible)</td></tr>
<tr><td><code>cik</code></td><td>String</td><td>320193</td></tr>
<tr><td><code>period_u_id</code></td><td>String</td><td>duration_2025-09-28_2025-12-27</td></tr>
<tr><td><code>member_u_ids</code></td><td>String[]</td><td>[] (empty for Total)</td></tr>
<tr><td><code>dimension_u_ids</code></td><td>String[]</td><td>[] (empty for Total)</td></tr>
</table>

<h3>Context u_id Structure</h3>
<div class="id-vis">
  <div class="id-seg"><div class="v" style="color:var(--dim);border-radius:6px 0 0 6px">guidance</div><div class="l">prefix</div></div>
  <div class="id-sep">_</div>
  <div class="id-seg"><div class="v" style="color:var(--orange)">320193</div><div class="l">CIK (from Company node)</div></div>
  <div class="id-sep">_</div>
  <div class="id-seg"><div class="v" style="color:var(--accent);border-radius:0 6px 6px 0">duration_2025-09-28_2025-12-27</div><div class="l">period_u_id</div></div>
</div>

<h3>Resolution Algorithm</h3>
<div class="flow-steps">
<div class="flow-step"><div class="step-num"></div><div class="step-content"><strong>Determine FYE</strong>: <code>get_derived_fye(ticker)</code> from 10-K periods. Resolve CIK from graph: <code>MATCH (c:Company {ticker: $ticker})</code> — never accept CIK from external input.</div></div>
<div class="flow-step"><div class="step-num"></div><div class="step-content"><strong>Determine fiscal period dates</strong>: <code>fiscal_to_dates(fye_month, fiscal_year, fiscal_quarter)</code> → (start, end). For 52/53-week filers: (a) try exact prior-company fiscal slot from existing XBRL Period history, (b) if missing, project prior slot by +52 and +53 weeks, (c) choose candidate matching company weekday pattern and nearest expected quarter end. <em>This is code-only — LLM must not do fiscal date math.</em></div></div>
<div class="flow-step"><div class="step-num"></div><div class="step-content"><strong>Compute deterministic IDs</strong>: <code>period_u_id = "duration_{start}_{end}"</code> or <code>"other_medium_term"</code> / <code>"undefined"</code>. Then <code>ctx_u_id = "guidance_" + cik + "_" + period_u_id</code></div></div>
<div class="flow-step"><div class="step-num"></div><div class="step-content"><strong>Search for existing Context</strong>: <code>MATCH (ctx:Context {u_id: $ctx_u_id})</code>. If found → reuse. If not → CREATE.</div></div>
</div>

<h3>MERGE Cypher (Create or Reuse)</h3>
<div class="cypher">MATCH (company:Company {ticker: $ticker})
WITH company, company.cik AS cik
MERGE (p:Period {u_id: $period_u_id})
  ON CREATE SET p.id = $period_u_id,
                p.period_type = $period_node_type,
                p.start_date = $start,
                p.end_date = $end
MERGE (ctx:Context {u_id: $ctx_u_id})
  ON CREATE SET ctx.id = $ctx_u_id,
                ctx.context_id = $ctx_u_id,
                ctx.cik = cik,
                ctx.period_u_id = $period_u_id,
                ctx.member_u_ids = [],
                ctx.dimension_u_ids = []
MERGE (ctx)-[:HAS_PERIOD]->(p)
MERGE (ctx)-[:FOR_COMPANY]->(company)</div>

<h3>Period Scenario Table</h3>
<table>
<tr><th>Scenario</th><th>Example Text</th><th>period_u_id</th><th>Dates</th></tr>
<tr><td><strong>Specific quarter</strong></td><td>"Q3 FY2025"</td><td><code>duration_2025-06-29_2025-09-27</code></td><td>Exact fiscal dates</td></tr>
<tr><td><strong>Annual</strong></td><td>"fiscal year 2025"</td><td><code>duration_2024-09-29_2025-09-27</code></td><td>Full fiscal year</td></tr>
<tr><td><strong>Half year</strong></td><td>"second half"</td><td><code>duration_2025-03-30_2025-09-27</code></td><td>Best-effort from FYE</td></tr>
<tr><td><strong>Vague future</strong></td><td>"next year"</td><td>Best-effort from FYE</td><td>Derived from fiscal calendar</td></tr>
<tr><td><strong>Long-range</strong></td><td>"by 2028"</td><td><code>other_long_range_2028</code></td><td>null / null</td></tr>
<tr><td><strong>Medium-term</strong></td><td>"over medium term"</td><td><code>other_medium_term</code></td><td>null / null</td></tr>
<tr><td><strong>No period</strong></td><td>(unclear)</td><td><code>undefined</code></td><td>null / null</td></tr>
</table>
`
},
{
  id: "xbrl",
  num: "§7",
  title: "XBRL Matching & Confidence Gates",
  color: "#58a6ff",
  content: `
<h3>Design</h3>
<p>All linking is inline in the same extraction run. LLM may propose candidates, but only cache-backed candidates passing deterministic gates are written. <strong>Failures never block core writes.</strong></p>

<h3>Warmup Caches (Once Per Company Per Run)</h3>
<div class="diagram">
<div class="dbox"><div class="dbox-label cyan">Concept Cache</div>
<p>qname → best_concept_u_id</p>
<p class="dim">Resolves multi-namespace versions by selecting company-dominant u_id per qname. Handles the fact that same qname exists across 5+ taxonomy years.</p>
</div>
<div class="dbox"><div class="dbox-label cyan">Member Cache</div>
<p>member_qname → best_member_u_id</p>
<p class="dim">Context-based discovery (not FACT_MEMBER). CIK padding normalized. Filtered to segment/product axes only.</p>
</div>
</div>

<h3>Concept Pattern Map</h3>
<table>
<tr><th>Guidance Label</th><th>qname Pattern</th><th>Exclude</th></tr>
<tr><td>Revenue</td><td>Revenue</td><td>RemainingPerformanceObligation</td></tr>
<tr><td>EPS</td><td>EarningsPerShareDiluted</td><td>—</td></tr>
<tr><td>Gross Margin</td><td>GrossProfit</td><td>—</td></tr>
<tr><td>Operating Income</td><td>OperatingIncomeLoss</td><td>—</td></tr>
<tr><td>Net Income</td><td>NetIncome, ProfitLoss</td><td>—</td></tr>
<tr><td>OpEx</td><td>OperatingExpenses</td><td>—</td></tr>
<tr><td>Tax Rate</td><td>EffectiveIncomeTaxRate</td><td>—</td></tr>
<tr><td>CapEx</td><td>PaymentsToAcquirePropertyPlant...</td><td>—</td></tr>
<tr><td>D&A</td><td>DepreciationAmortization</td><td>—</td></tr>
</table>
<p class="dim">Operating Margin, FCF, OINE — no direct concept (derived metrics)</p>

<h3>Confidence Gates</h3>
<div class="diagram">
<div class="dbox"><div class="dbox-label purple">Concept Link (Guidance → Concept)</div>
<ul>
<li>Candidate must be in concept cache + pattern map</li>
<li><code>best_usage > 0</code></li>
<li>Dominance: <code>best / total ≥ 60%</code></li>
<li>Links <code>Concept {u_id: best_concept_u_id}</code></li>
</ul>
</div>
<div class="dbox"><div class="dbox-label cyan">Member Link (GuidanceUpdate → Member)</div>
<ul>
<li>Only when <code>segment ≠ "Total"</code></li>
<li>Normalize: lowercase, trim, remove "member"/"segment", singularize</li>
<li>Require exactly ONE unique normalized match</li>
<li>Ambiguous or no match → skip</li>
</ul>
</div>
</div>

<h3>Dropped from Design</h3>
<ul>
<li><strong>MAPS_TO_DIMENSION</strong> — zero information gain (Member implies Dimension)</li>
<li><strong>Domain links</strong> — hierarchy root only, no actionable data</li>
<li>Axis fields from cache are diagnostics only; no edge written</li>
</ul>
`
},
{
  id: "ordering",
  num: "§8",
  title: "Chronological Ordering (No Linked List)",
  color: "#8b949e",
  content: `
<h3>Decision</h3>
<p>GuidanceUpdate nodes do <strong>NOT</strong> maintain NEXT/PREVIOUS edges. Ordering is entirely query-time.</p>

<h3>Ordering Rule</h3>
<div class="cypher">-- Chronological (oldest first)
ORDER BY gu.given_date, gu.id

-- Latest first
ORDER BY gu.given_date DESC, gu.id DESC</div>

<p>Primary: <code>given_date</code>. Tie-breaker: <code>id</code> (deterministic, stable).</p>

<h3>Rationale</h3>
<ul>
<li>Avoids write-time chain maintenance complexity</li>
<li>Works for both chronological initial builds AND out-of-order single-source backfills</li>
<li>No linked-list repair needed when reprocessing</li>
</ul>

<h3>Basis Safety</h3>
<p>Mixed bases (GAAP and non-GAAP) may appear in the same metric history. <strong>Do not compare consecutive values unless partitioned by <code>basis_norm</code> first.</strong></p>
`
},
{
  id: "predictor",
  num: "§9",
  title: "Predictor Queries (3 Patterns)",
  color: "#bc8cff",
  content: `
<h3>1. Full History (PIT-filtered)</h3>
<div class="cypher">MATCH (gu:GuidanceUpdate)-[:UPDATES]->(g:Guidance)
MATCH (gu)-[:IN_CONTEXT]->(ctx:Context)-[:FOR_COMPANY]->(c:Company {ticker: $ticker})
MATCH (ctx)-[:HAS_PERIOD]->(p:Period)
WHERE gu.given_date <= $pit_date
MATCH (gu)-[:FROM_SOURCE]->(src)
OPTIONAL MATCH (g)-[:MAPS_TO_CONCEPT]->(con:Concept)
OPTIONAL MATCH (gu)-[:MAPS_TO_MEMBER]->(m:Member)
RETURN g.label AS metric, con.qname AS xbrl_concept,
       gu.given_date, gu.period_type, gu.fiscal_year, gu.fiscal_quarter,
       gu.segment, gu.basis_norm, gu.basis_raw, gu.low, gu.mid, gu.high, gu.unit,
       gu.derivation, gu.qualitative, gu.quote, gu.section, gu.conditions,
       p.start_date, p.end_date,
       labels(src)[0] AS source_type, src.id AS source_id,
       m.label AS xbrl_member
ORDER BY g.label, gu.given_date, gu.id</div>

<h3>2. Latest Value Per Metric + Basis + Segment</h3>
<div class="cypher">MATCH (gu:GuidanceUpdate)-[:UPDATES]->(g:Guidance)
MATCH (gu)-[:IN_CONTEXT]->(ctx:Context)-[:FOR_COMPANY]->(c:Company {ticker: $ticker})
WHERE gu.given_date <= $pit_date
WITH g, ctx, gu.basis_norm AS basis_norm, gu.segment AS segment,
     gu ORDER BY gu.given_date DESC, gu.id DESC
WITH g, ctx, basis_norm, segment, collect(gu)[0] AS latest
MATCH (ctx)-[:HAS_PERIOD]->(p:Period)
RETURN g.label AS metric, basis_norm, segment, latest.basis_raw,
       latest.low, latest.mid, latest.high, latest.unit, latest.qualitative,
       latest.given_date, latest.fiscal_year, latest.fiscal_quarter,
       p.start_date, p.end_date</div>

<h3>3. Accuracy Comparison (Guided vs Actual)</h3>
<div class="cypher">-- Guidance value
MATCH (gu:GuidanceUpdate)-[:UPDATES]->(g:Guidance)-[:MAPS_TO_CONCEPT]->(con:Concept)
MATCH (gu)-[:IN_CONTEXT]->(ctx:Context)-[:FOR_COMPANY]->(c:Company {ticker: $ticker})
MATCH (ctx)-[:HAS_PERIOD]->(p:Period)
-- XBRL actual for same concept + same company + overlapping period
MATCH (f:Fact)-[:HAS_CONCEPT]->(con)
MATCH (f)-[:IN_CONTEXT]->(fctx:Context)-[:FOR_COMPANY]->(c)
MATCH (fctx)-[:HAS_PERIOD]->(fp:Period)
WHERE fp.start_date = p.start_date AND fp.end_date = p.end_date
  AND f.is_numeric = '1'
RETURN g.label, gu.mid AS guided, toFloat(f.value) AS actual,
       toFloat(f.value) - gu.mid AS surprise</div>

<p class="dim"><strong>Boundary</strong>: Extraction writes to graph. Predictor reads from it. No coupling.</p>
`
},
{
  id: "pipeline",
  num: "§10",
  title: "Extraction Pipeline (Full Flow)",
  color: "#3fb950",
  content: `
<h3>Trigger Modes</h3>
<div class="diagram">
<div class="dbox"><div class="dbox-label green">Auto (Primary)</div>
<p>Per-asset trigger when asset-ready gate passes</p>
<p class="dim">Day-1 coverage: 8k, transcript, 10q, 10k, news</p>
</div>
<div class="dbox"><div class="dbox-label orange">SDK Single (Backfill)</div>
<p><code>/guidance-inventory {TICKER} {SOURCE_TYPE} {SOURCE_ID}</code></p>
<p class="dim">Process one specific document</p>
</div>
<div class="dbox"><div class="dbox-label purple">SDK Initial (Full Build)</div>
<p><code>/guidance-inventory {TICKER} initial</code></p>
<p class="dim">All historical sources chronologically</p>
</div>
</div>

<h3>Stage 1: Load Context</h3>
<div class="diagram">
<div class="dbox"><div class="dbox-label green">Fiscal</div><code>get_derived_fye(ticker)</code><br>Read CIK from Company node</div>
<div class="dbox"><div class="dbox-label cyan">XBRL Caches</div>Concept usage cache<br>Member cache (CIK-pad safe)</div>
<div class="dbox"><div class="dbox-label purple">Existing Tags</div>Load existing Guidance labels for LLM reuse</div>
</div>

<div class="arrow-d">↓</div>

<h3>Stage 2: Source-Routed LLM Extraction</h3>
<div class="diagram">
<div class="dbox"><div class="dbox-label orange">Route</div>8k → outlook/tables<br>transcript → full scan<br>news → channel filter first<br>10q/10k → MD&A only</div>
<div class="dbox"><div class="dbox-label green">Recall</div>Keyword windows → signal filter → LLM<br>Fallback full-scope if 0 hits on 8K/transcript</div>
<div class="dbox"><div class="dbox-label accent">LLM Output</div>quote, metric, period, values, basis, derivation, qualitative, XBRL candidates</div>
</div>

<div class="arrow-d">↓</div>

<h3>Stage 2.5: Deterministic Validation (Code-Only Gate)</h3>
<div class="diagram">
<div class="dbox"><div class="dbox-label pink">Canonicalize</div>Unit normalization (usd/m_usd/percent)<br>Numeric scale alignment<br>slug(label), slug(segment)</div>
<div class="dbox"><div class="dbox-label pink">Validate</div>Basis: qualifier not in quote span → unknown<br>Period: <code>fiscal_to_dates()</code> (code-only)<br>No citation = no node</div>
<div class="dbox"><div class="dbox-label pink">Gates</div>Concept: cache + dominance ≥60%<br>Member: exact normalized match<br>Fail → keep write, skip link</div>
</div>

<div class="arrow-d">↓</div>

<h3>Stage 3: Graph Write (Per Item)</h3>
<div class="flow-steps">
<div class="flow-step"><div class="step-num"></div><div class="step-content">Compute deterministic IDs via shared utility: <code>guidance_id</code>, <code>evhash16</code>, <code>guidance_update_id</code></div></div>
<div class="flow-step"><div class="step-num"></div><div class="step-content"><code>MERGE (g:Guidance {id})</code> — ON CREATE set label, aliases, created_date</div></div>
<div class="flow-step"><div class="step-num"></div><div class="step-content">Find/create Context via §6 MERGE pattern</div></div>
<div class="flow-step"><div class="step-num"></div><div class="step-content"><code>MERGE (gu:GuidanceUpdate {id})</code> — ON CREATE set all 19 properties + evhash16</div></div>
<div class="flow-step"><div class="step-num"></div><div class="step-content">Link: <code>gu→UPDATES→g</code>, <code>gu→FROM_SOURCE→src</code>, <code>gu→IN_CONTEXT→ctx</code></div></div>
<div class="flow-step"><div class="step-num"></div><div class="step-content">Link XBRL if confident: Concept on Guidance, Member on Update</div></div>
</div>

<h3>Idempotency</h3>
<div class="cypher">MERGE (gu:GuidanceUpdate {id: $guidance_update_id})
ON CREATE SET gu += $all_properties, gu.evhash16 = $evhash16
RETURN gu
-- If MERGE matches → no-op. Force flag can delete + re-extract.</div>

<h3>Initial Build Order</h3>
<p>All historical sources chronologically (oldest first). Per earnings event: <strong>8-K → news → transcript → 10-Q</strong>. Each extraction adds to graph incrementally.</p>
`
},
{
  id: "deferred",
  num: "§11",
  title: "Deferred Items",
  color: "#8b949e",
  content: `
<table>
<tr><th>Item</th><th>Status</th><th>Notes</th></tr>
<tr><td>Analyst estimate extraction</td><td>Deferred</td><td>"Est $X" = analyst, not company. Future: extract with correct attribution.</td></tr>
<tr><td>Accuracy tracking</td><td>Predictor's job</td><td>Compare Guidance vs XBRL Fact at prediction time (§9)</td></tr>
<tr><td>Investor day / presentations</td><td>When ingested</td><td>Any doc asset is a candidate. Not yet in pipeline.</td></tr>
<tr><td>Perplexity gap-filling</td><td>Available</td><td>Last resort. Assume subscription.</td></tr>
<tr><td>Markdown generation</td><td>On demand</td><td>Generate readable report from graph if humans need it. Not stored.</td></tr>
<tr><td>Neo4j write access</td><td><strong>Must verify</strong></td><td><code>mcp__neo4j-cypher__write_neo4j_cypher</code> needed in skill tools</td></tr>
</table>
`
},
{
  id: "decisions",
  num: "§12",
  title: "Finalized Decisions (30)",
  color: "#d29922",
  content: `
<table>
<tr><th>#</th><th>Decision</th><th>Resolution</th></tr>
<tr><td>1</td><td>Data store</td><td>Neo4j graph (not markdown file)</td></tr>
<tr><td>2</td><td>Guidance node</td><td>Generic concept, not per-company</td></tr>
<tr><td>3</td><td>GuidanceUpdate node</td><td>Per-mention, 19 fields (includes basis_norm + basis_raw)</td></tr>
<tr><td>4</td><td>Company association</td><td>Through Context (cik→FOR_COMPANY→Company)</td></tr>
<tr><td>5</td><td>Ordering model</td><td>No linked list. ORDER BY given_date, id</td></tr>
<tr><td>6</td><td>Action types</td><td>None — LLM determines from timeline</td></tr>
<tr><td>7</td><td>Supersession</td><td>None — latest by given_date is current</td></tr>
<tr><td>8</td><td>Anchor rule</td><td>None — first in timeline is implicit anchor</td></tr>
<tr><td>9</td><td>Source priority</td><td>None — process chronologically, attribute to source</td></tr>
<tr><td>10</td><td>Synthesis pass</td><td>None — graph structure handles it</td></tr>
<tr><td>11</td><td>Output format</td><td>Cypher query for predictor context (no markdown)</td></tr>
<tr><td>12</td><td>Trigger</td><td>Auto per asset. SDK single/initial for backfill.</td></tr>
<tr><td>13</td><td>News filtering</td><td>Benzinga channels: Guidance, Earnings, Beats/Misses, Previews, Management</td></tr>
<tr><td>14</td><td>XBRL linking</td><td>Concept on Guidance; Member on GuidanceUpdate. Dimension dropped.</td></tr>
<tr><td>15</td><td>Fiscal periods</td><td>Reuse get_derived_fye() + period_to_fiscal(); add fiscal_to_dates()</td></tr>
<tr><td>16</td><td>Metric normalization</td><td>Standard labels with aliases (§4)</td></tr>
<tr><td>17</td><td>Segment handling</td><td>Property + MAPS_TO_MEMBER if confident</td></tr>
<tr><td>18</td><td>Analyst estimates</td><td>Deferred</td></tr>
<tr><td>19</td><td>Accuracy tracking</td><td>Predictor's job</td></tr>
<tr><td>20</td><td>Execution mode</td><td>SDK-compatible, non-interactive</td></tr>
<tr><td>21</td><td>Missing data</td><td>Note for next round, not hard-fail</td></tr>
<tr><td>22</td><td>Context reuse</td><td>Same label as XBRL (Option A). Identical format.</td></tr>
<tr><td>23</td><td>Basis tracking</td><td>basis_norm + basis_raw. Assign only when explicit; else unknown.</td></tr>
<tr><td>24</td><td>Per-asset extraction</td><td>Route by source type before LLM. Separate scan/exclusion rules.</td></tr>
<tr><td>25</td><td>Metric normalization</td><td>12 canonical + LLM creates new as needed</td></tr>
<tr><td>26</td><td>Deterministic IDs</td><td>guidance:{slug} + gu:{7-part key} with evhash16. usd/m_usd split.</td></tr>
<tr><td>27</td><td>LLM governance</td><td>LLM proposes; deterministic validator enforces.</td></tr>
<tr><td>28</td><td>Derivation enum</td><td>7 types: explicit, calculated, point, implied, floor, ceiling, comparative</td></tr>
<tr><td>29</td><td>News reaffirm</td><td>Flag in conditions; extract exact source values (no tolerance).</td></tr>
<tr><td>30</td><td>Segment normalizer</td><td>Light singularization + small synonym map.</td></tr>
</table>
`
},
{
  id: "reusable",
  num: "§13",
  title: "Reusable Content & Must-Build",
  color: "#39d2c0",
  content: `
<h3>Reuse (Existing Code)</h3>
<table>
<tr><th>Content</th><th>Source</th><th>Action</th></tr>
<tr><td><code>period_to_fiscal()</code></td><td>get_quarterly_filings.py:61</td><td><span class="tag tag-reuse">REUSE</span> calendar→fiscal</td></tr>
<tr><td><code>get_derived_fye()</code></td><td>get_quarterly_filings.py:134</td><td><span class="tag tag-reuse">REUSE</span></td></tr>
<tr><td>Metric normalization</td><td>guidance-extract.md:258-269</td><td><span class="tag tag-reuse">CARRY</span> forward (§4)</td></tr>
<tr><td>Source extraction hints</td><td>guidance-extract.md:146-199</td><td><span class="tag tag-reuse">CARRY</span> forward (§3)</td></tr>
<tr><td>Derivation rules</td><td>guidance-extract.md:229-237</td><td><span class="tag tag-reuse">CARRY</span> forward (§5)</td></tr>
<tr><td>Segment rules</td><td>guidance-extract.md:242-252</td><td><span class="tag tag-reuse">CARRY</span> forward</td></tr>
<tr><td>Cypher queries</td><td>QUERIES.md</td><td><span class="tag tag-reuse">KEEP</span> fix labels</td></tr>
<tr><td>Fiscal calendar</td><td>FISCAL_CALENDAR.md</td><td><span class="tag tag-reuse">KEEP</span> as-is</td></tr>
<tr><td>Evidence standards</td><td>evidence-standards/SKILL.md</td><td><span class="tag tag-reuse">LOAD</span> during extraction</td></tr>
<tr><td>AAPL benchmark</td><td>sampleGuidance_byAgentTeams.md</td><td><span class="tag tag-ref">QUALITY TARGET</span></td></tr>
</table>

<h3>Must Build (New Code)</h3>
<table>
<tr><th>Content</th><th>Priority</th><th>Description</th></tr>
<tr><td><code>fiscal_to_dates()</code></td><td><span class="tag tag-new">P0</span></td><td>Reverse of period_to_fiscal: (fye_month, fy, fq) → (start, end). 52/53-week deterministic fallback.</td></tr>
<tr><td>ID normalization utility</td><td><span class="tag tag-new">P0</span></td><td>Shared helper for slugging, unit/scale canonicalization, evhash16, guidance_update_id assembly.</td></tr>
</table>
`
},
{
  id: "files",
  num: "§14",
  title: "Files to Update",
  color: "#f85149",
  content: `
<table>
<tr><th>File</th><th>Status</th><th>Action</th></tr>
<tr><td><code>guidance-extract.md</code> (agent)</td><td>May be superseded</td><td>Align with graph-native; core logic reused, invocation changes</td></tr>
<tr><td><code>guidance-inventory/SKILL.md</code></td><td>Needs rewrite</td><td>New invocation contract, Neo4j write, updated model</td></tr>
<tr><td><code>guidance-inventory/OUTPUT_TEMPLATE.md</code></td><td>Likely superseded</td><td>No markdown output; graph-native</td></tr>
<tr><td><code>guidance-inventory/QUERIES.md</code></td><td>Keep</td><td>Fix "Via Skill" labels</td></tr>
<tr><td><code>earnings-orchestrator.md</code></td><td>Already updated</td><td>Step 0 removed, I5 = graph query</td></tr>
</table>
`
}
];

// ════════════════════════════════════════════
// STATE
// ════════════════════════════════════════════
let state = {};
try { state = JSON.parse(localStorage.getItem('gv21_review') || '{}'); } catch(e) {}

function save() { localStorage.setItem('gv21_review', JSON.stringify(state)); }
function getState(id) { return state[id] || { status:'pending', comment:'' }; }

// ════════════════════════════════════════════
// RENDER
// ════════════════════════════════════════════
function render() {
  const nav = document.getElementById('nav');
  const main = document.getElementById('sections');
  nav.innerHTML = '';
  main.innerHTML = '';

  sections.forEach((s, i) => {
    const st = getState(s.id);

    // Nav item
    const ni = document.createElement('div');
    ni.className = 'nav-item' + (i===0?' active':'');
    ni.dataset.id = s.id;
    ni.innerHTML = `<div class="nav-dot ${st.status}"></div><div class="nav-label">${s.num} ${s.title}</div>`;
    ni.onclick = () => {
      document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
      ni.classList.add('active');
      document.getElementById('sec-'+s.id).scrollIntoView({behavior:'smooth',block:'start'});
    };
    nav.appendChild(ni);

    // Section
    const sec = document.createElement('div');
    sec.id = 'sec-'+s.id;
    sec.className = 'section' + (i<3?' open':'') + (st.status!=='pending'?' '+st.status:'');
    sec.innerHTML = `
      <div class="section-head" onclick="toggleSection('${s.id}')">
        <span class="section-chevron">&#9654;</span>
        <span class="section-tag" style="background:${s.color}22;color:${s.color}">${s.num}</span>
        <span class="section-title">${s.title}</span>
        <span class="section-status ${st.status}">${st.status}</span>
      </div>
      <div class="section-body">
        <div class="section-content">${s.content}</div>
        <div class="review">
          <div class="review-actions">
            <button class="review-btn approve ${st.status==='approved'?'active':''}" onclick="setStatus('${s.id}','approved')">&#10003; Approve</button>
            <button class="review-btn reject ${st.status==='rejected'?'active':''}" onclick="setStatus('${s.id}','rejected')">&#10007; Reject</button>
            <button class="review-btn comment ${st.comment?'active':''}" onclick="toggleComment('${s.id}')">&#9998; Comment</button>
          </div>
          <textarea class="review-comment ${st.comment?'show':''}" id="comment-${s.id}"
            placeholder="Add feedback, suggestions, or concerns..."
            oninput="saveComment('${s.id}',this.value)">${st.comment||''}</textarea>
        </div>
      </div>
    `;
    main.appendChild(sec);
  });

  updateProgress();
}

function toggleSection(id) {
  document.getElementById('sec-'+id).classList.toggle('open');
}

function setStatus(id, status) {
  const s = getState(id);
  s.status = s.status===status ? 'pending' : status;
  state[id] = s;
  save();
  render();
}

function toggleComment(id) {
  const el = document.getElementById('comment-'+id);
  el.classList.toggle('show');
  if(el.classList.contains('show')) el.focus();
}

function saveComment(id, val) {
  const s = getState(id);
  s.comment = val;
  if(val && s.status==='pending') s.status = 'commented';
  if(!val && s.status==='commented') s.status = 'pending';
  state[id] = s;
  save();
  updateProgress();
  // Update nav dot
  const dot = document.querySelector(`.nav-item[data-id="${id}"] .nav-dot`);
  if(dot) { dot.className = 'nav-dot ' + s.status; }
  const badge = document.querySelector(`#sec-${id} .section-status`);
  if(badge) { badge.className = 'section-status ' + s.status; badge.textContent = s.status; }
}

function updateProgress() {
  const reviewed = sections.filter(s => getState(s.id).status !== 'pending').length;
  document.getElementById('progressFill').style.width = (reviewed/sections.length*100)+'%';
  document.getElementById('progressText').textContent = `${reviewed} / ${sections.length} reviewed`;
}

function resetAll() {
  if(!confirm('Reset all reviews?')) return;
  state = {};
  save();
  render();
}

function showExport() {
  const lines = [];
  lines.push('# Guidance v2.1 — Review Summary');
  lines.push(`Date: ${new Date().toISOString().slice(0,10)}`);
  lines.push('');

  const approved = [], rejected = [], commented = [], pending = [];
  sections.forEach(s => {
    const st = getState(s.id);
    const entry = { num:s.num, title:s.title, comment:st.comment };
    if(st.status==='approved') approved.push(entry);
    else if(st.status==='rejected') rejected.push(entry);
    else if(st.status==='commented') commented.push(entry);
    else pending.push(entry);
  });

  if(approved.length) {
    lines.push(`## Approved (${approved.length})`);
    approved.forEach(e => {
      lines.push(`- ${e.num} ${e.title}`);
      if(e.comment) lines.push(`  > ${e.comment}`);
    });
    lines.push('');
  }
  if(rejected.length) {
    lines.push(`## Rejected (${rejected.length})`);
    rejected.forEach(e => {
      lines.push(`- ${e.num} ${e.title}`);
      if(e.comment) lines.push(`  > ${e.comment}`);
    });
    lines.push('');
  }
  if(commented.length) {
    lines.push(`## Comments (${commented.length})`);
    commented.forEach(e => {
      lines.push(`- ${e.num} ${e.title}`);
      if(e.comment) lines.push(`  > ${e.comment}`);
    });
    lines.push('');
  }
  if(pending.length) {
    lines.push(`## Not Yet Reviewed (${pending.length})`);
    pending.forEach(e => lines.push(`- ${e.num} ${e.title}`));
    lines.push('');
  }

  document.getElementById('exportContent').textContent = lines.join('\n');
  document.getElementById('modal').classList.add('show');
}

function closeModal() { document.getElementById('modal').classList.remove('show'); }

function copyExport() {
  const text = document.getElementById('exportContent').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('.modal-actions button:first-child');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy to Clipboard', 2000);
  });
}

// ── Scroll spy ──
const main_el = document.getElementById('main');
main_el.addEventListener('scroll', () => {
  const tops = sections.map(s => {
    const el = document.getElementById('sec-'+s.id);
    return { id:s.id, top: el ? el.getBoundingClientRect().top : 9999 };
  });
  const closest = tops.reduce((a,b) => Math.abs(a.top-80) < Math.abs(b.top-80) ? a : b);
  document.querySelectorAll('.nav-item').forEach(n => {
    n.classList.toggle('active', n.dataset.id === closest.id);
  });
});

render();
</script>
</body>
</html>
