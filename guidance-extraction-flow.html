<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Guidance Extraction Flow — v2.1</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --border: #30363d;
    --text: #e6edf3;
    --dim: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --orange: #d29922;
    --red: #f85149;
    --purple: #bc8cff;
    --cyan: #39d2c0;
    --pink: #f778ba;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', monospace; font-size: 13px; overflow-x: hidden; }

  .header { text-align: center; padding: 32px 20px 16px; border-bottom: 1px solid var(--border); }
  .header h1 { font-size: 22px; font-weight: 600; color: var(--accent); letter-spacing: -0.5px; }
  .header .sub { color: var(--dim); font-size: 12px; margin-top: 6px; }

  .tabs { display: flex; justify-content: center; gap: 4px; padding: 16px 20px 0; flex-wrap: wrap; }
  .tab { padding: 8px 16px; border-radius: 8px 8px 0 0; border: 1px solid var(--border); border-bottom: none; background: var(--surface); color: var(--dim); cursor: pointer; font-size: 12px; font-family: inherit; transition: all 0.2s; }
  .tab:hover { color: var(--text); }
  .tab.active { background: var(--bg); color: var(--accent); border-color: var(--accent); border-bottom: 2px solid var(--bg); position: relative; top: 1px; }

  .canvas { padding: 24px; max-width: 1200px; margin: 0 auto; }
  .view { display: none; }
  .view.active { display: block; }

  /* ── Flow diagram ── */
  .flow { display: flex; flex-direction: column; gap: 0; align-items: center; }
  .stage { width: 100%; max-width: 900px; border: 1px solid var(--border); border-radius: 10px; background: var(--surface); padding: 20px 24px; position: relative; }
  .stage-num { position: absolute; top: -10px; left: 20px; background: var(--accent); color: var(--bg); font-weight: 700; font-size: 11px; padding: 2px 10px; border-radius: 10px; }
  .stage-title { font-size: 15px; font-weight: 600; margin-bottom: 10px; color: var(--text); }
  .stage-body { display: flex; gap: 16px; flex-wrap: wrap; }
  .stage-desc { color: var(--dim); font-size: 12px; margin-bottom: 12px; line-height: 1.5; }

  .arrow-down { display: flex; justify-content: center; padding: 6px 0; }
  .arrow-down svg { width: 24px; height: 32px; }
  .arrow-down path { fill: none; stroke: var(--dim); stroke-width: 2; }
  .arrow-down polygon { fill: var(--dim); }

  /* ── Cards ── */
  .card { flex: 1; min-width: 180px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
  .card-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  .card-label.src { color: var(--orange); }
  .card-label.action { color: var(--green); }
  .card-label.node { color: var(--purple); }
  .card-label.query { color: var(--cyan); }
  .card-label.rule { color: var(--pink); }
  .card-content { font-size: 12px; line-height: 1.6; color: var(--text); }
  .card-content code { background: rgba(88,166,255,0.12); color: var(--accent); padding: 1px 5px; border-radius: 3px; font-size: 11px; }
  .card-content .dim { color: var(--dim); }

  /* ── Graph view ── */
  .graph-svg { width: 100%; height: auto; }
  .graph-container { text-align: center; }

  /* ── Source table ── */
  table { width: 100%; border-collapse: collapse; font-size: 12px; }
  th { text-align: left; padding: 10px 12px; border-bottom: 2px solid var(--accent); color: var(--accent); font-weight: 600; }
  td { padding: 8px 12px; border-bottom: 1px solid var(--border); color: var(--text); }
  tr:hover td { background: rgba(88,166,255,0.04); }
  .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; }
  .tag-yes { background: rgba(63,185,80,0.15); color: var(--green); }
  .tag-no { background: rgba(248,81,73,0.15); color: var(--red); }
  .tag-ref { background: rgba(188,140,255,0.15); color: var(--purple); }

  /* ── ID anatomy ── */
  .id-anatomy { display: flex; gap: 0; align-items: flex-start; flex-wrap: wrap; justify-content: center; margin: 24px 0; }
  .id-part { text-align: center; }
  .id-part .val { padding: 8px 6px; font-size: 14px; font-weight: 600; border: 1px solid var(--border); background: var(--surface); min-width: 60px; }
  .id-part .lbl { font-size: 10px; color: var(--dim); margin-top: 6px; line-height: 1.3; max-width: 120px; margin-left: auto; margin-right: auto; }
  .id-sep { font-size: 18px; color: var(--dim); padding-top: 8px; font-weight: 300; }
  .id-part:nth-child(1) .val { color: var(--dim); border-radius: 6px 0 0 6px; }
  .id-part:nth-child(3) .val { color: var(--orange); }
  .id-part:nth-child(5) .val { color: var(--green); }
  .id-part:nth-child(7) .val { color: var(--accent); }
  .id-part:nth-child(9) .val { color: var(--purple); }
  .id-part:nth-child(11) .val { color: var(--cyan); }
  .id-part:nth-child(13) .val { color: var(--pink); border-radius: 0 6px 6px 0; }

  /* ── Legend ── */
  .legend { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; padding: 16px; border: 1px solid var(--border); border-radius: 8px; margin-top: 20px; background: var(--surface); }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--dim); }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

  /* ── Responsive ── */
  @media (max-width: 700px) {
    .stage-body { flex-direction: column; }
    .card { min-width: 100%; }
    .id-anatomy { gap: 2px; }
    .id-part .val { font-size: 11px; padding: 6px 4px; min-width: 40px; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>Guidance Extraction Flow</h1>
  <div class="sub">Implementation Spec v2.1 &mdash; Graph-Native Architecture</div>
</div>

<div class="tabs">
  <button class="tab active" onclick="showView('flow')">Extraction Pipeline</button>
  <button class="tab" onclick="showView('graph')">Graph Schema</button>
  <button class="tab" onclick="showView('sources')">Source Routing</button>
  <button class="tab" onclick="showView('ids')">ID Anatomy</button>
  <button class="tab" onclick="showView('xbrl')">XBRL Linking</button>
</div>

<div class="canvas">

<!-- ═══════════════════════════════════════════════════════ -->
<!-- VIEW 1: EXTRACTION PIPELINE                            -->
<!-- ═══════════════════════════════════════════════════════ -->
<div class="view active" id="view-flow">

  <!-- STAGE 1 -->
  <div class="flow">
    <div class="stage">
      <div class="stage-num">STAGE 1</div>
      <div class="stage-title">Load Context</div>
      <div class="stage-desc">One-time setup per company per extraction run. Loads fiscal profile, XBRL caches, and existing guidance tags.</div>
      <div class="stage-body">
        <div class="card">
          <div class="card-label action">Fiscal Profile</div>
          <div class="card-content">
            <code>get_derived_fye(ticker)</code><br>
            <span class="dim">Derive FYE month from 10-K periods</span><br><br>
            <code>MATCH (c:Company {ticker})</code><br>
            <span class="dim">Read CIK from Company node</span>
          </div>
        </div>
        <div class="card">
          <div class="card-label query">XBRL Warmup Caches</div>
          <div class="card-content">
            <strong>Concept cache</strong><br>
            <span class="dim">qname &rarr; best_concept_u_id<br>Resolves multi-namespace versions</span><br><br>
            <strong>Member cache</strong><br>
            <span class="dim">member_qname &rarr; best_member_u_id<br>Context-based, CIK-pad safe</span>
          </div>
        </div>
        <div class="card">
          <div class="card-label query">Existing Tags</div>
          <div class="card-content">
            <code>MATCH (g:Guidance)</code><br>
            <span class="dim">Load existing Guidance labels<br>for this company so LLM can<br>reuse known metric names</span>
          </div>
        </div>
      </div>
    </div>

    <div class="arrow-down"><svg viewBox="0 0 24 32"><path d="M12 0 L12 24"/><polygon points="6,22 12,32 18,22"/></svg></div>

    <!-- STAGE 2 -->
    <div class="stage">
      <div class="stage-num">STAGE 2</div>
      <div class="stage-title">Source-Routed LLM Extraction</div>
      <div class="stage-desc">Each source type has its own scan scope, inclusion rules, and noise profile. Routing happens BEFORE the LLM sees content.</div>
      <div class="stage-body">
        <div class="card">
          <div class="card-label src">Route by source_type</div>
          <div class="card-content">
            <strong>8-K</strong> &rarr; Outlook, tables, footnotes<br>
            <strong>Transcript</strong> &rarr; Full scan (PR + Q&amp;A)<br>
            <strong>News</strong> &rarr; Channel filter first<br>
            <strong>10-Q/10-K</strong> &rarr; MD&amp;A section only
          </div>
        </div>
        <div class="card">
          <div class="card-label action">Recall Pass</div>
          <div class="card-content">
            1. Build text from scoped region<br>
            2. Find forward-guidance keyword hits<br>
            3. Keep windows with metric/period signals<br>
            4. Send candidate windows to LLM<br>
            5. <span class="dim">Fallback: full-scope if 0 hits (8K/transcript)</span>
          </div>
        </div>
        <div class="card">
          <div class="card-label action">LLM Output (per item)</div>
          <div class="card-content">
            &bull; quote + section citation<br>
            &bull; metric label + segment<br>
            &bull; period intent (FY/Q)<br>
            &bull; low / mid / high / unit<br>
            &bull; basis (explicit-only)<br>
            &bull; derivation type<br>
            &bull; qualitative text<br>
            &bull; XBRL link candidates
          </div>
        </div>
      </div>
    </div>

    <div class="arrow-down"><svg viewBox="0 0 24 32"><path d="M12 0 L12 24"/><polygon points="6,22 12,32 18,22"/></svg></div>

    <!-- STAGE 2.5 -->
    <div class="stage" style="border-color: var(--orange);">
      <div class="stage-num" style="background: var(--orange);">STAGE 2.5</div>
      <div class="stage-title">Deterministic Validation</div>
      <div class="stage-desc">Code-only gate between LLM output and graph write. LLM proposes, validator enforces. No LLM reasoning past this point.</div>
      <div class="stage-body">
        <div class="card">
          <div class="card-label rule">Canonicalize</div>
          <div class="card-content">
            &bull; Unit normalization<br>
            <span class="dim">&nbsp; per-share &rarr; <code>usd</code></span><br>
            <span class="dim">&nbsp; aggregate &rarr; <code>m_usd</code></span><br>
            <span class="dim">&nbsp; percentage &rarr; <code>percent</code></span><br>
            &bull; Numeric scale alignment<br>
            <span class="dim">&nbsp; $1.13B &rarr; 1130 m_usd</span><br>
            &bull; slug(label), slug(segment)
          </div>
        </div>
        <div class="card">
          <div class="card-label rule">Validate</div>
          <div class="card-content">
            &bull; <strong>Basis rule</strong>: qualifier not in<br>
            &nbsp; same quote span &rarr; <code>unknown</code><br>
            &bull; <strong>Period resolution</strong>:<br>
            &nbsp; <code>fiscal_to_dates(fye, fy, fq)</code><br>
            &nbsp; <span class="dim">52/53-week: check XBRL history,<br>
            &nbsp; project +52/+53 wks if missing</span><br>
            &bull; <strong>No citation = no node</strong>
          </div>
        </div>
        <div class="card">
          <div class="card-label rule">Confidence Gates</div>
          <div class="card-content">
            <strong>Concept</strong> (Guidance &rarr; Concept)<br>
            <span class="dim">&bull; Must be in concept cache</span><br>
            <span class="dim">&bull; usage &gt; 0, dominance &ge; 60%</span><br><br>
            <strong>Member</strong> (Update &rarr; Member)<br>
            <span class="dim">&bull; Only when segment &ne; Total</span><br>
            <span class="dim">&bull; Exact normalized match</span><br>
            <span class="dim">&bull; Ambiguous &rarr; skip link</span><br><br>
            <span class="dim">Fail &rarr; keep core write, skip link</span>
          </div>
        </div>
      </div>
    </div>

    <div class="arrow-down"><svg viewBox="0 0 24 32"><path d="M12 0 L12 24"/><polygon points="6,22 12,32 18,22"/></svg></div>

    <!-- STAGE 3 -->
    <div class="stage" style="border-color: var(--green);">
      <div class="stage-num" style="background: var(--green);">STAGE 3</div>
      <div class="stage-title">Graph Write (Per Item)</div>
      <div class="stage-desc">Compute deterministic IDs, MERGE nodes and relationships. Same ID = idempotent no-op.</div>
      <div class="stage-body">
        <div class="card">
          <div class="card-label node">Compute IDs</div>
          <div class="card-content">
            <code>guidance_id</code><br>
            <span class="dim">guidance:{slug(label)}</span><br><br>
            <code>evhash16</code><br>
            <span class="dim">sha256(low|mid|high|unit|qual|cond)[:16]</span><br><br>
            <code>guidance_update_id</code><br>
            <span class="dim">gu:{src}:{lbl}:{period}:{basis}:{seg}:{hash}</span>
          </div>
        </div>
        <div class="card">
          <div class="card-label node">MERGE Nodes</div>
          <div class="card-content">
            1. <code>MERGE (g:Guidance {id})</code><br>
            <span class="dim">&nbsp; ON CREATE: label, aliases, date</span><br><br>
            2. <code>MERGE (ctx:Context {u_id})</code><br>
            <span class="dim">&nbsp; + Period + FOR_COMPANY</span><br><br>
            3. <code>MERGE (gu:GuidanceUpdate {id})</code><br>
            <span class="dim">&nbsp; ON CREATE: all 19 properties</span>
          </div>
        </div>
        <div class="card">
          <div class="card-label node">Link Relationships</div>
          <div class="card-content">
            <code>gu &rarr; UPDATES &rarr; g</code><br>
            <span class="dim">always</span><br><br>
            <code>gu &rarr; FROM_SOURCE &rarr; src</code><br>
            <span class="dim">always (Report/Transcript/News)</span><br><br>
            <code>gu &rarr; IN_CONTEXT &rarr; ctx</code><br>
            <span class="dim">always (company + period)</span><br><br>
            <code>g &rarr; MAPS_TO_CONCEPT &rarr; Concept</code><br>
            <span class="dim">if confident XBRL match</span><br><br>
            <code>gu &rarr; MAPS_TO_MEMBER &rarr; Member</code><br>
            <span class="dim">if confident segment match</span>
          </div>
        </div>
      </div>
    </div>

    <div class="arrow-down"><svg viewBox="0 0 24 32"><path d="M12 0 L12 24"/><polygon points="6,22 12,32 18,22"/></svg></div>

    <!-- PREDICTOR -->
    <div class="stage" style="border-color: var(--purple); border-style: dashed;">
      <div class="stage-num" style="background: var(--purple);">READS</div>
      <div class="stage-title">Predictor / Consumer (Downstream)</div>
      <div class="stage-desc">Extraction writes. Prediction reads. No coupling between systems.</div>
      <div class="stage-body">
        <div class="card">
          <div class="card-label query">Full History (PIT)</div>
          <div class="card-content">
            <code>WHERE gu.given_date &lt;= $pit_date</code><br>
            <span class="dim">All guidance as of point-in-time</span><br>
            <span class="dim">ORDER BY g.label, gu.given_date, gu.id</span>
          </div>
        </div>
        <div class="card">
          <div class="card-label query">Latest Per Metric</div>
          <div class="card-content">
            <span class="dim">Group by (metric, basis, segment)</span><br>
            <code>collect(gu)[0]</code> <span class="dim">after DESC sort</span><br>
            <span class="dim">Returns current guidance snapshot</span>
          </div>
        </div>
        <div class="card">
          <div class="card-label query">Accuracy Check</div>
          <div class="card-content">
            <span class="dim">Join Guidance &rarr; Concept &rarr; Fact</span><br>
            <span class="dim">Same company + overlapping period</span><br>
            <code>actual - guided = surprise</code>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div> Action / Code</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--orange)"></div> Source / Input</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div> Graph Node</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--cyan)"></div> Cypher Query</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--pink)"></div> Validation Rule</div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════ -->
<!-- VIEW 2: GRAPH SCHEMA                                   -->
<!-- ═══════════════════════════════════════════════════════ -->
<div class="view" id="view-graph">
  <div class="graph-container">
    <svg class="graph-svg" viewBox="0 0 920 620" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <marker id="arrowG" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" fill="#8b949e"/>
        </marker>
        <marker id="arrowDash" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" fill="#58a6ff"/>
        </marker>
      </defs>

      <!-- Background grid -->
      <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
        <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#1a2030" stroke-width="0.5"/>
      </pattern>
      <rect width="920" height="620" fill="url(#grid)"/>

      <!-- ── EDGES (draw first, behind nodes) ── -->

      <!-- GuidanceUpdate -> Guidance (UPDATES) -->
      <line x1="360" y1="240" x2="360" y2="110" stroke="#8b949e" stroke-width="2" marker-end="url(#arrowG)"/>
      <text x="375" y="178" fill="#3fb950" font-size="11" font-family="monospace">UPDATES</text>

      <!-- GuidanceUpdate -> Context (IN_CONTEXT) -->
      <line x1="460" y1="280" x2="600" y2="280" stroke="#8b949e" stroke-width="2" marker-end="url(#arrowG)"/>
      <text x="490" y="272" fill="#3fb950" font-size="11" font-family="monospace">IN_CONTEXT</text>

      <!-- GuidanceUpdate -> Source nodes (FROM_SOURCE) -->
      <line x1="260" y1="300" x2="120" y2="400" stroke="#8b949e" stroke-width="2" marker-end="url(#arrowG)"/>
      <text x="145" y="345" fill="#3fb950" font-size="11" font-family="monospace">FROM_SOURCE</text>

      <!-- Context -> Company (FOR_COMPANY) -->
      <line x1="700" y1="320" x2="700" y2="440" stroke="#8b949e" stroke-width="2" marker-end="url(#arrowG)"/>
      <text x="715" y="385" fill="#3fb950" font-size="11" font-family="monospace">FOR_COMPANY</text>

      <!-- Context -> Period (HAS_PERIOD) -->
      <line x1="750" y1="270" x2="850" y2="180" stroke="#8b949e" stroke-width="2" marker-end="url(#arrowG)"/>
      <text x="790" y="215" fill="#3fb950" font-size="11" font-family="monospace">HAS_PERIOD</text>

      <!-- Guidance -> Concept (MAPS_TO_CONCEPT) - dashed = optional -->
      <line x1="440" y1="70" x2="600" y2="70" stroke="#58a6ff" stroke-width="2" stroke-dasharray="6,4" marker-end="url(#arrowDash)"/>
      <text x="460" y="60" fill="#58a6ff" font-size="11" font-family="monospace">MAPS_TO_CONCEPT</text>

      <!-- GuidanceUpdate -> Member (MAPS_TO_MEMBER) - dashed = optional -->
      <line x1="400" y1="320" x2="570" y2="480" stroke="#58a6ff" stroke-width="2" stroke-dasharray="6,4" marker-end="url(#arrowDash)"/>
      <text x="440" y="410" fill="#58a6ff" font-size="11" font-family="monospace">MAPS_TO_MEMBER</text>

      <!-- ── NODES ── -->

      <!-- Guidance -->
      <rect x="260" y="42" width="200" height="56" rx="10" fill="#1a1a2e" stroke="#bc8cff" stroke-width="2"/>
      <text x="310" y="66" fill="#bc8cff" font-size="14" font-weight="bold" font-family="monospace">Guidance</text>
      <text x="280" y="86" fill="#8b949e" font-size="10" font-family="monospace">id | label | aliases</text>

      <!-- GuidanceUpdate -->
      <rect x="260" y="240" width="200" height="80" rx="10" fill="#1a1a2e" stroke="#3fb950" stroke-width="2"/>
      <text x="282" y="266" fill="#3fb950" font-size="14" font-weight="bold" font-family="monospace">GuidanceUpdate</text>
      <text x="280" y="286" fill="#8b949e" font-size="10" font-family="monospace">id | evhash16 | 19 fields</text>
      <text x="280" y="302" fill="#8b949e" font-size="10" font-family="monospace">low | mid | high | unit ...</text>

      <!-- Context (reused) -->
      <rect x="600" y="246" width="180" height="56" rx="10" fill="#1a1a2e" stroke="#39d2c0" stroke-width="2"/>
      <text x="647" y="270" fill="#39d2c0" font-size="14" font-weight="bold" font-family="monospace">Context</text>
      <text x="618" y="290" fill="#8b949e" font-size="10" font-family="monospace">u_id | cik | period_u_id</text>

      <!-- Period -->
      <rect x="810" y="140" width="100" height="56" rx="10" fill="#1a1a2e" stroke="#39d2c0" stroke-width="2"/>
      <text x="832" y="164" fill="#39d2c0" font-size="14" font-weight="bold" font-family="monospace">Period</text>
      <text x="822" y="184" fill="#8b949e" font-size="10" font-family="monospace">start | end</text>

      <!-- Company -->
      <rect x="630" y="450" width="140" height="56" rx="10" fill="#1a1a2e" stroke="#d29922" stroke-width="2"/>
      <text x="660" y="474" fill="#d29922" font-size="14" font-weight="bold" font-family="monospace">Company</text>
      <text x="648" y="494" fill="#8b949e" font-size="10" font-family="monospace">ticker | cik</text>

      <!-- Concept (XBRL) -->
      <rect x="600" y="42" width="160" height="56" rx="10" fill="#1a1a2e" stroke="#58a6ff" stroke-width="2" stroke-dasharray="6,4"/>
      <text x="635" y="66" fill="#58a6ff" font-size="14" font-weight="bold" font-family="monospace">Concept</text>
      <text x="618" y="86" fill="#8b949e" font-size="10" font-family="monospace">qname | label (XBRL)</text>

      <!-- Member (XBRL) -->
      <rect x="530" y="460" width="100" height="56" rx="10" fill="#1a1a2e" stroke="#58a6ff" stroke-width="2" stroke-dasharray="6,4"/>
      <text x="547" y="484" fill="#58a6ff" font-size="14" font-weight="bold" font-family="monospace">Member</text>
      <text x="540" y="504" fill="#8b949e" font-size="10" font-family="monospace">label (XBRL)</text>

      <!-- Source: Report -->
      <rect x="30" y="390" width="160" height="46" rx="8" fill="#1a1a2e" stroke="#d29922" stroke-width="1.5"/>
      <text x="56" y="414" fill="#d29922" font-size="13" font-weight="bold" font-family="monospace">Report</text>
      <text x="120" y="414" fill="#8b949e" font-size="10" font-family="monospace">(8-K/10-Q/10-K)</text>

      <!-- Source: Transcript -->
      <rect x="30" y="446" width="160" height="36" rx="8" fill="#1a1a2e" stroke="#d29922" stroke-width="1.5"/>
      <text x="60" y="468" fill="#d29922" font-size="13" font-weight="bold" font-family="monospace">Transcript</text>

      <!-- Source: News -->
      <rect x="30" y="492" width="160" height="36" rx="8" fill="#1a1a2e" stroke="#d29922" stroke-width="1.5"/>
      <text x="82" y="514" fill="#d29922" font-size="13" font-weight="bold" font-family="monospace">News</text>

      <!-- Dashed connectors for other sources -->
      <line x1="120" y1="446" x2="260" y2="310" stroke="#8b949e" stroke-width="1" stroke-dasharray="4,3"/>
      <line x1="120" y1="492" x2="260" y2="315" stroke="#8b949e" stroke-width="1" stroke-dasharray="4,3"/>

      <!-- Legend -->
      <rect x="20" y="560" width="880" height="50" rx="8" fill="#161b22" stroke="#30363d"/>
      <line x1="50" y1="585" x2="90" y2="585" stroke="#8b949e" stroke-width="2"/>
      <text x="95" y="589" fill="#8b949e" font-size="11" font-family="monospace">Always created</text>
      <line x1="250" y1="585" x2="290" y2="585" stroke="#58a6ff" stroke-width="2" stroke-dasharray="6,4"/>
      <text x="295" y="589" fill="#8b949e" font-size="11" font-family="monospace">Optional (confidence-gated)</text>
      <rect x="520" y="576" width="16" height="16" rx="3" fill="#1a1a2e" stroke="#3fb950" stroke-width="1.5"/>
      <text x="542" y="589" fill="#8b949e" font-size="11" font-family="monospace">New node types</text>
      <rect x="700" y="576" width="16" height="16" rx="3" fill="#1a1a2e" stroke="#d29922" stroke-width="1.5"/>
      <text x="722" y="589" fill="#8b949e" font-size="11" font-family="monospace">Existing / Reused</text>
    </svg>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════ -->
<!-- VIEW 3: SOURCE ROUTING TABLE                           -->
<!-- ═══════════════════════════════════════════════════════ -->
<div class="view" id="view-sources">
  <h2 style="color:var(--accent); margin-bottom:16px; font-size:16px;">Source Processing Rules</h2>
  <p style="color:var(--dim); margin-bottom:20px; font-size:12px; line-height:1.5;">
    Each source type routes to a different extraction profile BEFORE the LLM sees content.
    The table defines what to scan, what to extract, and what to ignore.
  </p>
  <table>
    <tr>
      <th>Source</th>
      <th>Richness</th>
      <th>Extract?</th>
      <th>Scan Scope</th>
      <th>given_date</th>
      <th>source_key</th>
      <th>Exclude</th>
    </tr>
    <tr>
      <td><strong style="color:var(--green)">Transcript</strong></td>
      <td>Highest</td>
      <td><span class="tag tag-yes">YES</span></td>
      <td>Full: CFO, CEO, Q&amp;A</td>
      <td><code>conference_datetime</code></td>
      <td><code>full</code></td>
      <td>&mdash;</td>
    </tr>
    <tr>
      <td><strong style="color:var(--green)">8-K EX-99.1</strong></td>
      <td>High</td>
      <td><span class="tag tag-yes">YES</span></td>
      <td>Outlook &rarr; tables &rarr; footnotes</td>
      <td><code>r.created</code></td>
      <td><code>EX-99.1</code></td>
      <td>Actuals, safe harbor</td>
    </tr>
    <tr>
      <td><strong style="color:var(--green)">News</strong></td>
      <td>Medium</td>
      <td><span class="tag tag-yes">YES</span></td>
      <td>Title + body (post channel filter)</td>
      <td><code>n.created</code></td>
      <td><code>title</code></td>
      <td>Analyst estimates ("Est $X")</td>
    </tr>
    <tr>
      <td><strong style="color:var(--green)">10-Q / 10-K</strong></td>
      <td>Low</td>
      <td><span class="tag tag-yes">YES</span></td>
      <td>MD&amp;A section only</td>
      <td><code>r.created</code></td>
      <td><code>MD&A</code></td>
      <td>Boilerplate</td>
    </tr>
    <tr>
      <td style="color:var(--dim)">XBRL</td>
      <td>None</td>
      <td><span class="tag tag-no">NO</span></td>
      <td>&mdash;</td>
      <td>&mdash;</td>
      <td>&mdash;</td>
      <td>Actuals only (predictor uses)</td>
    </tr>
    <tr>
      <td style="color:var(--dim)">Alpha Vantage</td>
      <td>Reference</td>
      <td><span class="tag tag-ref">REF</span></td>
      <td>&mdash;</td>
      <td>&mdash;</td>
      <td>&mdash;</td>
      <td>Consensus, not guidance</td>
    </tr>
  </table>

  <h3 style="color:var(--orange); margin:28px 0 12px; font-size:14px;">News Channel Filter (Applied Pre-LLM)</h3>
  <table>
    <tr><th>Channel</th><th>Priority</th><th>Count</th></tr>
    <tr><td>Guidance</td><td><span class="tag tag-yes">PRIMARY</span></td><td>21,085</td></tr>
    <tr><td>Earnings</td><td><span class="tag tag-yes">PRIMARY</span></td><td>49,344</td></tr>
    <tr><td>Earnings Beats</td><td><span class="tag tag-ref">SECONDARY</span></td><td>5,784</td></tr>
    <tr><td>Earnings Misses</td><td><span class="tag tag-ref">SECONDARY</span></td><td>2,679</td></tr>
    <tr><td>Previews</td><td><span class="tag tag-ref">SECONDARY</span></td><td>587</td></tr>
    <tr><td>Management</td><td><span class="tag tag-ref">SECONDARY</span></td><td>4,409</td></tr>
  </table>

  <h3 style="color:var(--pink); margin:28px 0 12px; font-size:14px;">Derivation Types</h3>
  <table>
    <tr><th>Type</th><th>When</th><th>low/mid/high</th><th>Example</th></tr>
    <tr><td><code>explicit</code></td><td>All 3 values stated</td><td>All from source</td><td>"revenue of $94-97B"</td></tr>
    <tr><td><code>calculated</code></td><td>Agent computed mid</td><td>low+high given</td><td>mid = (94+97)/2</td></tr>
    <tr><td><code>point</code></td><td>Single value</td><td>all same</td><td>"CapEx of ~$2B"</td></tr>
    <tr><td><code>implied</code></td><td>Qualitative only</td><td>all null</td><td>"low single digits"</td></tr>
    <tr><td><code>floor</code></td><td>Lower bound only</td><td>low set</td><td>"at least $150M"</td></tr>
    <tr><td><code>ceiling</code></td><td>Upper bound only</td><td>high set</td><td>"up to $500M"</td></tr>
    <tr><td><code>comparative</code></td><td>Relative phrasing</td><td>all null</td><td>"roughly in line with Q2"</td></tr>
  </table>
</div>

<!-- ═══════════════════════════════════════════════════════ -->
<!-- VIEW 4: ID ANATOMY                                     -->
<!-- ═══════════════════════════════════════════════════════ -->
<div class="view" id="view-ids">
  <h2 style="color:var(--accent); margin-bottom:8px; font-size:16px;">GuidanceUpdate ID — Deterministic &amp; Readable</h2>
  <p style="color:var(--dim); margin-bottom:24px; font-size:12px; line-height:1.5;">
    Every GuidanceUpdate has a deterministic ID built from 7 components. Same input = same ID = MERGE no-op.
    No UUIDs, no sequences, fully idempotent.
  </p>

  <div class="id-anatomy">
    <div class="id-part"><div class="val">gu</div><div class="lbl">prefix</div></div>
    <div class="id-sep">:</div>
    <div class="id-part"><div class="val">0000320193-25-000008</div><div class="lbl">source_id<br><span style="color:var(--orange)">accession / transcript ID</span></div></div>
    <div class="id-sep">:</div>
    <div class="id-part"><div class="val">revenue</div><div class="lbl">label_slug<br><span style="color:var(--green)">slug(label)</span></div></div>
    <div class="id-sep">:</div>
    <div class="id-part"><div class="val">duration_2025-01-01_2025-03-31</div><div class="lbl">period_u_id<br><span style="color:var(--accent)">from Context resolution</span></div></div>
    <div class="id-sep">:</div>
    <div class="id-part"><div class="val">non_gaap</div><div class="lbl">basis_norm<br><span style="color:var(--purple)">enum as-is</span></div></div>
    <div class="id-sep">:</div>
    <div class="id-part"><div class="val">total</div><div class="lbl">segment_slug<br><span style="color:var(--cyan)">slug(segment)</span></div></div>
    <div class="id-sep">:</div>
    <div class="id-part"><div class="val">a3f8b21c9e4d7012</div><div class="lbl">evhash16<br><span style="color:var(--pink)">sha256(values)[:16]</span></div></div>
  </div>

  <div style="margin-top:32px;">
    <h3 style="color:var(--pink); margin-bottom:12px; font-size:14px;">evhash16 — Evidence Hash</h3>
    <div class="stage" style="max-width:700px; margin:0 auto;">
      <div class="stage-body" style="flex-direction:column; gap:12px;">
        <div style="color:var(--dim); font-size:12px; line-height:1.8;">
          <strong style="color:var(--text)">Input string:</strong><br>
          <code style="font-size:13px;">{low}|{mid}|{high}|{unit}|{qualitative}|{conditions}</code><br><br>
          <strong style="color:var(--text)">Canonicalization rules:</strong><br>
          &bull; Numerics: canonical decimal after unit normalization (<code>$1.13B</code> &rarr; <code>1130</code>)<br>
          &bull; Aggregate currency &rarr; <code>m_usd</code> &nbsp;|&nbsp; Per-share &rarr; <code>usd</code> &nbsp;|&nbsp; Percentage &rarr; <code>percent</code><br>
          &bull; Text fields: lowercase + trimmed + whitespace-collapsed<br>
          &bull; Nulls encoded as <code>.</code><br><br>
          <strong style="color:var(--text)">Output:</strong> <code>sha256(input_string)[:16]</code> &rarr; 16 hex chars<br><br>
          <strong style="color:var(--text)">Effect:</strong><br>
          &bull; Same values + same conditions = same hash = same ID = MERGE no-op<br>
          &bull; Changed value or condition = different hash = new GuidanceUpdate node
        </div>
      </div>
    </div>
  </div>

  <div style="margin-top:32px;">
    <h3 style="color:var(--green); margin-bottom:12px; font-size:14px;">Guidance ID (Simpler)</h3>
    <div class="id-anatomy" style="justify-content:flex-start;">
      <div class="id-part"><div class="val" style="color:var(--dim)">guidance</div><div class="lbl">prefix</div></div>
      <div class="id-sep">:</div>
      <div class="id-part"><div class="val" style="color:var(--green)">revenue</div><div class="lbl">slug(label)<br><span style="color:var(--dim)">shared across all companies</span></div></div>
    </div>
  </div>

  <div style="margin-top:32px;">
    <h3 style="color:var(--cyan); margin-bottom:12px; font-size:14px;">Context u_id</h3>
    <div class="id-anatomy" style="justify-content:flex-start;">
      <div class="id-part"><div class="val" style="color:var(--dim)">guidance</div><div class="lbl">prefix</div></div>
      <div class="id-sep">_</div>
      <div class="id-part"><div class="val" style="color:var(--orange)">320193</div><div class="lbl">CIK<br><span style="color:var(--dim)">from Company node</span></div></div>
      <div class="id-sep">_</div>
      <div class="id-part"><div class="val" style="color:var(--accent)">duration_2025-01-01_2025-03-31</div><div class="lbl">period_u_id</div></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════ -->
<!-- VIEW 5: XBRL LINKING                                   -->
<!-- ═══════════════════════════════════════════════════════ -->
<div class="view" id="view-xbrl">
  <h2 style="color:var(--accent); margin-bottom:8px; font-size:16px;">XBRL Inline Linking</h2>
  <p style="color:var(--dim); margin-bottom:24px; font-size:12px; line-height:1.5;">
    Two optional links bridge guidance to XBRL taxonomy. Both are confidence-gated &mdash; failures never block core writes. Caches are warmed once per company per run (zero per-item DB queries for linking).
  </p>

  <div class="flow" style="gap:20px;">

    <div class="stage">
      <div class="stage-num" style="background:var(--purple);">LINK 1</div>
      <div class="stage-title">Guidance &rarr; MAPS_TO_CONCEPT &rarr; Concept</div>
      <div class="stage-desc">Links the generic metric tag to its XBRL concept. One link per metric across all companies.</div>
      <div class="stage-body">
        <div class="card">
          <div class="card-label query">Concept Pattern Map</div>
          <div class="card-content">
            <code>Revenue</code> &rarr; qname contains <code>Revenue</code><br>
            <code>EPS</code> &rarr; <code>EarningsPerShareDiluted</code><br>
            <code>Gross Margin</code> &rarr; <code>GrossProfit</code><br>
            <code>Operating Income</code> &rarr; <code>OperatingIncomeLoss</code><br>
            <code>CapEx</code> &rarr; <code>PaymentsToAcquire...</code><br>
            <span class="dim">+ 7 more canonical metrics</span>
          </div>
        </div>
        <div class="card">
          <div class="card-label rule">Confidence Gate</div>
          <div class="card-content">
            1. Candidate must be in concept cache<br>
            2. <code>best_usage &gt; 0</code><br>
            3. Dominance: <code>best / total &ge; 60%</code><br>
            4. Multi-namespace safe: links <code>u_id</code><br>
            <br>
            <span class="dim">Fail any &rarr; skip link, keep write</span>
          </div>
        </div>
        <div class="card">
          <div class="card-label action">Result</div>
          <div class="card-content">
            <span style="color:var(--green);">Pass:</span><br>
            <code>(g:Guidance)-[:MAPS_TO_CONCEPT]->(con:Concept)</code><br><br>
            <span style="color:var(--red);">Fail:</span><br>
            <span class="dim">No link created. Guidance node still written.</span><br><br>
            <span class="dim">Enables accuracy query:<br>
            Guidance &rarr; Concept &rarr; Fact (same period)</span>
          </div>
        </div>
      </div>
    </div>

    <div class="stage">
      <div class="stage-num" style="background:var(--cyan);">LINK 2</div>
      <div class="stage-title">GuidanceUpdate &rarr; MAPS_TO_MEMBER &rarr; Member</div>
      <div class="stage-desc">Links segment-level guidance to its XBRL Member node. Only when segment &ne; "Total".</div>
      <div class="stage-body">
        <div class="card">
          <div class="card-label query">Member Cache</div>
          <div class="card-content">
            Context-based discovery (not FACT_MEMBER)<br>
            <span class="dim">Robust when FACT_MEMBER is sparse</span><br><br>
            CIK padding normalized:<br>
            <code>0000320193</code> and <code>320193</code><br>
            <span class="dim">both resolve to same Member</span><br><br>
            Filtered to segment/product axes only
          </div>
        </div>
        <div class="card">
          <div class="card-label rule">Matching</div>
          <div class="card-content">
            1. Normalize both sides:<br>
            <span class="dim">&nbsp; lowercase, trim, remove "member"/"segment"</span><br>
            <span class="dim">&nbsp; singularize: services&rarr;service</span><br><br>
            2. Require exactly ONE unique match<br>
            3. Ambiguous &rarr; skip<br>
            4. No match &rarr; skip<br><br>
            <span class="dim">From dry run: ~2% of items get member links<br>(AAPL: 1/11, CIEN: 0/15, CAG: 0/23)</span>
          </div>
        </div>
        <div class="card">
          <div class="card-label action">Result</div>
          <div class="card-content">
            <span style="color:var(--green);">Pass:</span><br>
            <code>(gu)-[:MAPS_TO_MEMBER]->(m:Member)</code><br><br>
            <span style="color:var(--red);">Fail:</span><br>
            <span class="dim">No link. GuidanceUpdate still written<br>with segment as string property.</span><br><br>
            <span class="dim">Dropped from design:<br>
            &bull; MAPS_TO_DIMENSION (zero info gain)<br>
            &bull; Domain links (hierarchy root only)</span>
          </div>
        </div>
      </div>
    </div>

    <div class="stage" style="border-color:var(--dim); border-style:dashed; max-width:700px;">
      <div class="stage-num" style="background:var(--dim);">PARALLEL</div>
      <div class="stage-title">XBRL ↔ Guidance Architecture Parallel</div>
      <div class="stage-body">
        <div class="card" style="flex:1;">
          <div class="card-label" style="color:var(--accent);">XBRL Pattern</div>
          <div class="card-content">
            <code>Concept</code> &mdash; generic metric definition<br>
            <code>Fact</code> &mdash; per-mention data point<br>
            <code>Context</code> &mdash; company + period scoping<br>
            <code>Fact &rarr; IN_CONTEXT &rarr; Context</code><br>
            <code>Fact &rarr; HAS_CONCEPT &rarr; Concept</code>
          </div>
        </div>
        <div class="card" style="flex:0 0 30px; display:flex; align-items:center; justify-content:center; background:none; border:none; font-size:28px; color:var(--dim);">
          =
        </div>
        <div class="card" style="flex:1;">
          <div class="card-label" style="color:var(--green);">Guidance Pattern</div>
          <div class="card-content">
            <code>Guidance</code> &mdash; generic metric definition<br>
            <code>GuidanceUpdate</code> &mdash; per-mention data point<br>
            <code>Context</code> &mdash; company + period (REUSED!)<br>
            <code>GuidanceUpdate &rarr; IN_CONTEXT &rarr; Context</code><br>
            <code>GuidanceUpdate &rarr; UPDATES &rarr; Guidance</code>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</div><!-- /canvas -->

<script>
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  event.target.classList.add('active');
}
</script>
</body>
</html>
